<!-- Test Case Editor - Enhanced UX -->
<div class="test-case-editor-container">

  <!-- Sticky Header with Refinement Controls -->
  <div class="sticky-header" *ngIf="showRefinementControls">
    <!-- Grouped Refinement Card -->
    <div class="refinement-card">
      <div class="refinement-card-header">
        <h4 class="refinement-card-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="title-icon">
            <path fill-rule="evenodd"
              d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
              clip-rule="evenodd" />
          </svg>
          Configuración del Refinamiento
        </h4>
        <p class="refinement-card-description">
          Selecciona una técnica ISTQB y proporciona contexto adicional para refinar los casos con IA.
        </p>
      </div>

      <div class="refinement-controls-grid">
        <!-- Técnica ISTQB -->
        <div class="form-group">
          <label for="refinementTechnique">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
              <path fill-rule="evenodd"
                d="M15.988 3.012A2.25 2.25 0 0013.75 2H6.25a2.25 2.25 0 00-2.238 2.012L4 16.25A2.25 2.25 0 006.25 18h7.5A2.25 2.25 0 0016 15.75l.012-12.738z"
                clip-rule="evenodd" />
            </svg>
            Técnica ISTQB:
          </label>
          <select id="refinementTechnique" [(ngModel)]="refinementTechnique"
            (ngModelChange)="onRefinementTechniqueChange(); onTestCaseChange()" [disabled]="isLoading">
            <option value="" disabled>Selecciona una técnica</option>
            <option value="Equivalent Partitioning">Partición Equivalente</option>
            <option value="Boundary Value Analysis">Análisis de Valor Límite</option>
            <option value="Decision Table Testing">Tabla de Decisión</option>
            <option value="State Transition Testing">Pruebas de Transición de Estados</option>
            <option value="Use Case Testing">Pruebas basadas en Casos de Uso</option>
            <option value="Error Guessing">Predicción de Errores</option>
          </select>
        </div>

        <!-- Enhanced Context Textarea -->
        <div class="form-group">
          <label for="userRefinementContext">
            Contexto adicional (opcional):
          </label>
          <div class="context-textarea-wrapper">
            <textarea id="userRefinementContext" class="enhanced-context-textarea" [(ngModel)]="userRefinementContext"
              (ngModelChange)="onUserRefinementContextChange(); onTestCaseChange()"
              placeholder="Agrega criterios específicos o restricciones del sistema. Ej: El campo solo acepta números, validar escenarios de error..."
              rows="4" [disabled]="isLoading"></textarea>
          </div>
        </div>
      </div>

      <!-- Aligned Actions - Only AI Button -->
      <div class="refinement-actions aligned-actions-center">
        <!-- Enhanced AI Button with Animation -->
        <button type="button" class="btn-refine-ai prominent-ai-btn animated-ai-btn"
          (click)="refineWithAI.emit({ technique: refinementTechnique, context: userRefinementContext })"
          [disabled]="!refinementTechnique || isLoading" title="Generar pasos con IA según técnica ISTQB">
          <svg *ngIf="!isLoading" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
            class="btn-icon ai-icon-animated">
            <path fill-rule="evenodd"
              d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
              clip-rule="evenodd" />
          </svg>
          <span *ngIf="isLoading" class="spinner-ai">
            <span class="spinner-dot"></span>
            <span class="spinner-dot"></span>
            <span class="spinner-dot"></span>
          </span>
          {{ isLoading ? 'Generando...' : 'Refinar con IA' }}
        </button>
      </div>
    </div>
  </div>

  <!-- 8. Separated Test Cases Section -->
  <div class="test-cases-section-wrapper">
    <div class="section-divider"></div>

    <div class="test-cases-header">
      <h4 class="test-cases-title">

        Casos de Prueba ({{ testCases.length }})
      </h4>
      <button type="button" class="btn-add-test-case" (click)="addTestCase()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        Agregar nuevo caso
      </button>
    </div>

    <!-- 10. Smart Empty State -->
    <div class="empty-test-cases smart-empty-state" *ngIf="testCases.length === 0">
      <div class="empty-icon"></div>
      <p class="empty-title">No hay casos de prueba aún</p>
      <p class="empty-description">Crea tu primer caso para comenzar</p>
      <button type="button" class="btn-empty-action" (click)="addTestCase()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        Añadir Caso
      </button>
    </div>

    <!-- 9. Scrollable Test Cases Container -->
    <div class="test-cases-scroll-container" *ngIf="testCases.length > 0">
      <!-- 4. Mini Cards for Test Cases -->
      <div *ngFor="let tc of testCases; let tcIndex = index" class="test-case-mini-card"
        [class.expanded]="tc.isExpanded">

        <!-- Card Header -->
        <div class="mini-card-header" (click)="toggleTestCaseExpansion(tc, tcIndex)">
          <div class="mini-card-left">
            <span class="case-badge">{{ tcIndex + 1 }}</span>
            <div class="case-info">
              <span class="case-title">{{ tc.title || 'Sin título' }}</span>
              <span class="case-subtitle" *ngIf="tc.steps && tc.steps.length > 0">
                {{ tc.steps.length }} {{ tc.steps.length === 1 ? 'paso' : 'pasos' }}
              </span>
            </div>
          </div>
          <div class="mini-card-actions" (click)="$event.stopPropagation()">
            <button type="button" class="btn-delete-mini" (click)="deleteTestCase(tcIndex)"
              title="Eliminar caso de prueba">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z"
                  clip-rule="evenodd" />
              </svg>
            </button>
            <div class="expand-chevron" [class.rotated]="tc.isExpanded">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Card Content with Accordion Animation -->
        <div class="mini-card-content" *ngIf="tc.isExpanded">
          <div class="card-divider"></div>
          <form class="test-case-form">

            <!-- Title -->
            <div class="form-group">
              <label [for]="'testCaseTitle-' + tcIndex">Título del Caso de Prueba:</label>
              <input [id]="'testCaseTitle-' + tcIndex" type="text" [(ngModel)]="tc.title"
                (ngModelChange)="onTestCaseChange()" [name]="'testCaseTitle-' + tcIndex"
                placeholder="Ej: Verificar acceso a la pantalla Ajustes Contables" required>
            </div>

            <!-- Preconditions -->
            <div class="form-group">
              <label [for]="'testCasePreconditions-' + tcIndex">Prefacio:</label>
              <textarea [id]="'testCasePreconditions-' + tcIndex" [(ngModel)]="tc.preconditions"
                (ngModelChange)="onTestCaseChange()" [name]="'testCasePreconditions-' + tcIndex"
                placeholder="Condiciones que deben cumplirse antes de ejecutar este caso" rows="2"></textarea>
            </div>

            <!-- Steps Section -->
            <div class="steps-section">
              <div class="steps-header">
                <h5>Pasos de Ejecución:</h5>
                <button type="button" class="btn-add-step" (click)="addStep(tc)">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                    <path
                      d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                  </svg>
                  Añadir paso
                </button>
              </div>

              <!-- 10. Smart Empty State for Steps -->
              <div class="no-steps smart-empty-state-small" *ngIf="!tc.steps || tc.steps.length === 0">
                <span class="empty-icon-small"></span>
                <p>Este caso aún no tiene pasos.</p>
                <button type="button" class="btn-empty-action-small" (click)="addStep(tc)">
                  + Añadir Paso
                </button>
              </div>

              <div class="steps-list" *ngIf="tc.steps && tc.steps.length > 0">
                <div *ngFor="let step of tc.steps; let stepIndex = index" class="step-item"
                  [class.dragging]="draggedStep === step && draggedStepTestCase === tc"
                  [class.drag-over]="dragOverStepId === (huId + '-tc' + tcIndex + '-step' + stepIndex)" draggable="true"
                  (dragstart)="onStepDragStart($event, step, tc)" (dragover)="onStepDragOver($event, step, tc)"
                  (drop)="onStepDrop($event, step, tc)" (dragleave)="onStepDragLeave($event)"
                  (dragend)="onStepDragEnd($event)">

                  <div class="step-drag-handle" title="Arrastra para reordenar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                      <path fill-rule="evenodd"
                        d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>

                  <span class="step-number">{{ stepIndex + 1 }}</span>

                  <div class="step-content">
                    <textarea [(ngModel)]="step.accion" (ngModelChange)="onTestCaseChange()"
                      [name]="'stepAction-tc' + tcIndex + '-step' + stepIndex"
                      placeholder="Describe la acción a realizar en este paso" rows="2"></textarea>
                  </div>

                  <div class="step-actions">
                    <button type="button" class="btn-delete-step" (click)="requestDeleteStep(tc, stepIndex)"
                      title="Eliminar paso">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                        <path fill-rule="evenodd"
                          d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z"
                          clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Expected Results -->
            <div class="form-group">
              <label [for]="'testCaseExpectedResults-' + tcIndex">Resultados esperados:</label>
              <textarea [id]="'testCaseExpectedResults-' + tcIndex" [(ngModel)]="tc.expectedResults"
                (ngModelChange)="onTestCaseChange()" [name]="'testCaseExpectedResults-' + tcIndex"
                placeholder="Describe el resultado esperado al ejecutar todos los pasos" rows="2"></textarea>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<app-confirmation-modal [isOpen]="isDeleteModalOpen" [title]="deleteModalTitle" [message]="deleteModalMessage"
  confirmText="Eliminar" cancelText="Cancelar" type="danger" (confirm)="confirmDeletion()"
  (cancel)="closeDeleteModal()">
</app-confirmation-modal>