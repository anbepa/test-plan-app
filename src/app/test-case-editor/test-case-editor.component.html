<!-- src/app/test-case-editor/test-case-editor.component.html -->
<div class="test-case-editor-container">
  <!-- Controles de Refinamiento -->
  <div class="refinement-controls" *ngIf="showRefinementControls">
    <div class="refinement-header">
      <h4 class="refinement-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="title-icon">
          <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
        </svg>
        Refinamiento y Edición de Casos de Prueba
        <span *ngIf="isLoading" class="spinner-inline"></span>
      </h4>
      <p class="refinement-description">
        Selecciona una técnica ISTQB y proporciona contexto adicional para refinar los casos con IA, o edita manualmente cada caso.
      </p>
    </div>

    <div class="refinement-controls-grid">
      <div class="form-group">
        <label for="refinementTechnique">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
            <path fill-rule="evenodd" d="M15.988 3.012A2.25 2.25 0 0013.75 2H6.25a2.25 2.25 0 00-2.238 2.012L4 16.25A2.25 2.25 0 006.25 18h7.5A2.25 2.25 0 0016 15.75l.012-12.738zM6 4.25a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5a.75.75 0 01-.75-.75zm-.75 3.5a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5z" clip-rule="evenodd" />
          </svg>
          Técnica ISTQB:<span class="required-indicator">*</span>
        </label>
        <select 
          id="refinementTechnique" 
          name="refinementTechnique" 
          [(ngModel)]="refinementTechnique" 
          (ngModelChange)="onRefinementTechniqueChange(); onTestCaseChange()"
          required 
          class="form-control" 
          [disabled]="isLoading">
          <option value="" disabled>Selecciona una técnica</option>
          <option value="Equivalent Partitioning">Partición Equivalente</option>
          <option value="Boundary Value Analysis">Análisis de Valor Límite</option>
          <option value="Decision Table Testing">Tabla de Decisión</option>
          <option value="State Transition Testing">Pruebas de Transición de Estados</option>
          <option value="Use Case Testing">Pruebas basadas en Casos de Uso</option>
          <option value="Error Guessing">Predicción de Errores</option>
        </select>
        <div *ngIf="!refinementTechnique" class="validation-hint">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="hint-icon">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
          </svg>
          Selecciona una técnica para habilitar el refinamiento con IA
        </div>
      </div>

      <div class="form-group">
        <label for="userRefinementContext">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
            <path d="M3.75 3A1.75 1.75 0 002 4.75v10.5c0 .966.784 1.75 1.75 1.75h12.5A1.75 1.75 0 0018 15.25V4.75A1.75 1.75 0 0016.25 3H3.75z" />
          </svg>
          Contexto Adicional (opcional):
        </label>
        <textarea 
          id="userRefinementContext" 
          name="userRefinementContext" 
          class="form-control" 
          rows="3" 
          [(ngModel)]="userRefinementContext"
          (ngModelChange)="onUserRefinementContextChange(); onTestCaseChange()"
          placeholder="Ej: Considerar que el campo X solo acepta números. Enfocarse en escenarios de error para el login."
          [disabled]="isLoading" 
          (input)="autoGrowTextarea($event.target)">
        </textarea>
      </div>
    </div>

    <div class="refinement-actions">
      <button 
        type="button" 
        (click)="onRefineWithAI()" 
        class="button-primary refine-button" 
        [disabled]="isLoading || !refinementTechnique">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="button-icon">
          <path d="M15.98 1.804a1 1 0 00-1.96 0l-.24 1.192a1 1 0 01-.784.785l-1.192.238a1 1 0 000 1.962l1.192.238a1 1 0 01.785.785l.238 1.192a1 1 0 001.962 0l.238-1.192a1 1 0 01.785-.785l1.192-.238a1 1 0 000-1.962l-1.192-.238a1 1 0 01-.785-.785l-.238-1.192zM6.949 5.684a1 1 0 00-1.898 0l-.683 2.051a1 1 0 01-.633.633l-2.051.683a1 1 0 000 1.898l2.051.684a1 1 0 01.633.632l.683 2.051a1 1 0 001.898 0l.683-2.051a1 1 0 01.633-.633l2.051-.683a1 1 0 000-1.898l-2.051-.683a1 1 0 01-.633-.633L6.95 5.684zM13.949 13.684a1 1 0 00-1.898 0l-.184.551a1 1 0 01-.632.633l-.551.183a1 1 0 000 1.898l.551.183a1 1 0 01.633.633l.183.551a1 1 0 001.898 0l.184-.551a1 1 0 01.632-.633l.551-.183a1 1 0 000-1.898l-.551-.184a1 1 0 01-.633-.632l-.183-.551z" />
        </svg>
        <span *ngIf="isLoading" class="spinner-inline"></span>
        {{ isLoading ? 'Procesando...' : 'Refinar con IA' }}
      </button>
      <button 
        type="button" 
        (click)="onCancel()" 
        class="button-secondary cancel-button" 
        [disabled]="isLoading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="button-icon">
          <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
        </svg>
        Volver a Previsualización
      </button>
    </div>
  </div>

  <!-- Editor de Casos de Prueba -->
  <div class="test-cases-editor">
    <div class="test-cases-count-badge">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="badge-icon">
        <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.5 7a.5.5 0 000 1h5a.5.5 0 000-1h-5zm0 2a.5.5 0 000 1h5a.5.5 0 000-1h-5zm0 2a.5.5 0 000 1h5a.5.5 0 000-1h-5z" clip-rule="evenodd" />
      </svg>
      {{ testCases.length || 0 }} Casos de Prueba
    </div>

    <div 
      *ngFor="let tc of testCases; let tcIndex = index" 
      class="test-case-card"
      [attr.id]="'test-case-card-' + huId + '-' + tcIndex"
      [class.expanded]="tc.isExpanded">
      
      <div class="test-case-header" (click)="toggleTestCaseExpansion(tc, tcIndex)">
        <div class="header-left">
          <span class="expansion-icon">
            <svg *ngIf="tc.isExpanded" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
            <svg *ngIf="!tc.isExpanded" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </span>
          <span class="test-case-number">Caso #{{ tcIndex + 1 }}</span>
        </div>
        <input 
          type="text" 
          class="test-case-title-input" 
          [(ngModel)]="tc.title" 
          (ngModelChange)="onTestCaseChange()"
          placeholder="Título del Caso de Prueba" 
          [disabled]="isLoading" 
          (click)="$event.stopPropagation()">
      </div>

      <div *ngIf="tc.isExpanded" class="test-case-body">
        <!-- Precondiciones -->
        <div class="form-group">
          <label [attr.for]="'tcPreconditions-' + huId + '-' + tcIndex">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
            </svg>
            Precondiciones:
          </label>
          <textarea 
            [attr.id]="'tcPreconditions-' + huId + '-' + tcIndex" 
            class="form-control" 
            [(ngModel)]="tc.preconditions" 
            (ngModelChange)="onTestCaseChange()"
            rows="2" 
            [disabled]="isLoading" 
            (input)="autoGrowTextarea($event.target)"
            placeholder="Condiciones que deben cumplirse antes de ejecutar este caso">
          </textarea>
        </div>

        <!-- Pasos del Caso de Prueba -->
        <div class="steps-section">
          <h5 class="steps-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="title-icon">
              <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
            </svg>
            Pasos del Caso de Prueba
          </h5>
          
          <div class="steps-table-container">
            <table class="steps-table">
              <thead>
                <tr>
                  <th class="step-number-col">Paso</th>
                  <th class="step-action-col">Acción</th>
                  <th class="step-delete-col">Eliminar</th>
                </tr>
              </thead>
              <tbody>
                <tr 
                  *ngFor="let step of tc.steps; let stepIndex = index"
                  [attr.draggable]="!isLoading"
                  (dragstart)="!isLoading && onStepDragStart($event, step, tc)"
                  (drop)="!isLoading && onStepDrop($event, step, tc)"
                  (dragend)="!isLoading && onStepDragEnd($event)"
                  (dragover)="!isLoading && onStepDragOver($event, step, tc)"
                  (dragleave)="!isLoading && onStepDragLeave($event)"
                  [class.drag-over]="dragOverStepId === getStepDragId(tc, step)"
                  [class.dragging]="!isLoading">
                  <td class="step-number">
                    <span class="step-badge">{{ step.numero_paso }}</span>
                  </td>
                  <td class="step-action">
                    <textarea 
                      class="form-control step-textarea" 
                      [(ngModel)]="step.accion" 
                      (ngModelChange)="onTestCaseChange()"
                      rows="1" 
                      placeholder="Descripción del paso"
                      (input)="autoGrowTextarea($event.target)" 
                      [disabled]="isLoading">
                    </textarea>
                  </td>
                  <td class="step-delete">
                    <button 
                      (click)="!isLoading && deleteTestCaseStep(tc, stepIndex)" 
                      class="delete-step-button" 
                      title="Eliminar Paso" 
                      [disabled]="isLoading"
                      type="button">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="(!tc.steps || tc.steps.length === 0) && !isLoading" class="empty-row">
                  <td colspan="3">
                    <div class="empty-message">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="empty-icon">
                        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                      </svg>
                      No hay pasos definidos. Haz clic en "Añadir Paso" para crear uno.
                    </div>
                  </td>
                </tr>
                <tr *ngIf="isLoading && (!tc.steps || tc.steps.length === 0)" class="loading-row">
                  <td colspan="3">
                    <div class="loading-message">
                      <span class="spinner-inline"></span>
                      Cargando pasos...
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button 
            type="button" 
            (click)="!isLoading && addTestCaseStep(tc)" 
            class="add-step-button" 
            title="Añadir Paso" 
            [disabled]="isLoading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="button-icon">
              <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
            </svg>
            Añadir Paso
          </button>
        </div>

        <!-- Resultados Esperados -->
        <div class="form-group">
          <label [attr.for]="'tcExpectedResults-' + huId + '-' + tcIndex">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
              <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
            </svg>
            Resultados Esperados:
          </label>
          <textarea 
            [attr.id]="'tcExpectedResults-' + huId + '-' + tcIndex" 
            class="form-control" 
            [(ngModel)]="tc.expectedResults" 
            (ngModelChange)="onTestCaseChange()"
            rows="3" 
            [disabled]="isLoading" 
            (input)="autoGrowTextarea($event.target)"
            placeholder="Resultados que se esperan obtener al ejecutar este caso">
          </textarea>
        </div>
      </div>
    </div>

    <div *ngIf="!testCases || testCases.length === 0" class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="empty-icon">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <p class="empty-text">No hay casos de prueba disponibles</p>
      <p class="empty-subtext">Genera casos de prueba para comenzar a editarlos</p>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <span class="spinner-large"></span>
      <p>Procesando con IA...</p>
    </div>
  </div>
</div>
