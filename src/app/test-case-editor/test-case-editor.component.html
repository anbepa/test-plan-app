<!-- Test Case Editor - Apple Style -->
<div class="test-case-editor-container">
  
  <!-- Refinement Controls -->
  <div class="refinement-controls" *ngIf="showRefinementControls">
    <div class="refinement-header">
      <h4 class="refinement-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="title-icon">
          <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
        </svg>
        Refinamiento y Edición de Casos de Prueba
      </h4>
      <p class="refinement-description">
        Selecciona una técnica ISTQB y proporciona contexto adicional para refinar los casos con IA, o edita manualmente cada caso.
      </p>
    </div>

    <div class="refinement-controls-grid">
      <!-- Técnica ISTQB -->
      <div class="form-group">
        <label for="refinementTechnique">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
            <path fill-rule="evenodd" d="M15.988 3.012A2.25 2.25 0 0013.75 2H6.25a2.25 2.25 0 00-2.238 2.012L4 16.25A2.25 2.25 0 006.25 18h7.5A2.25 2.25 0 0016 15.75l.012-12.738z" clip-rule="evenodd" />
          </svg>
          Técnica ISTQB:
        </label>
        <select 
          id="refinementTechnique"
          [(ngModel)]="refinementTechnique"
          (ngModelChange)="onRefinementTechniqueChange(); onTestCaseChange()"
          [disabled]="isLoading">
          <option value="" disabled>Selecciona una técnica</option>
          <option value="Equivalent Partitioning">Partición Equivalente</option>
          <option value="Boundary Value Analysis">Análisis de Valor Límite</option>
          <option value="Decision Table Testing">Tabla de Decisión</option>
          <option value="State Transition Testing">Pruebas de Transición de Estados</option>
          <option value="Use Case Testing">Pruebas basadas en Casos de Uso</option>
          <option value="Error Guessing">Predicción de Errores</option>
        </select>
      </div>

      <!-- Contexto adicional -->
      <div class="form-group">
        <label for="userRefinementContext">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="label-icon">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
          </svg>
          Contexto adicional (opcional):
        </label>
        <textarea
          id="userRefinementContext"
          [(ngModel)]="userRefinementContext"
          (ngModelChange)="onUserRefinementContextChange(); onTestCaseChange()"
          placeholder="Ej: Considerar que el campo X solo acepta números. Enfocarse en escenarios de error para el inicio de sesión."
          rows="4"
          [disabled]="isLoading"></textarea>
      </div>
    </div>

    <!-- Actions -->
    <div class="refinement-actions">
      <button 
        type="button"
        class="btn-refine-ai"
        (click)="refineWithAI.emit({ technique: refinementTechnique, context: userRefinementContext })"
        [disabled]="!refinementTechnique || isLoading">
        <svg *ngIf="!isLoading" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
          <path d="M15.98 1.804a1 1 0 00-1.96 0l-.24 1.192a1 1 0 01-.784.785l-1.192.238a1 1 0 000 1.962l1.192.238a1 1 0 01.785.785l.238 1.192a1 1 0 001.962 0l.238-1.192a1 1 0 01.785-.785l1.192-.238a1 1 0 000-1.962l-1.192-.238a1 1 0 01-.785-.785l-.238-1.192zM6.949 5.684a1 1 0 00-1.898 0l-.683 2.051a1 1 0 01-.633.633l-2.051.683a1 1 0 000 1.898l2.051.684a1 1 0 01.633.632l.683 2.051a1 1 0 001.898 0l.683-2.051a1 1 0 01.633-.633l2.051-.683a1 1 0 000-1.898l-2.051-.683a1 1 0 01-.633-.633L6.95 5.684zM13.949 13.684a1 1 0 00-1.898 0l-.184.551a1 1 0 01-.632.633l-.551.183a1 1 0 000 1.898l.551.183a1 1 0 01.633.633l.183.551a1 1 0 001.898 0l.184-.551a1 1 0 01.632-.633l.551-.183a1 1 0 000-1.898l-.551-.184a1 1 0 01-.633-.632l-.183-.551z" />
        </svg>
        <span *ngIf="isLoading" class="spinner"></span>
        {{ isLoading ? 'Refinando...' : 'Refinar con IA' }}
      </button>
      
      <button 
        type="button"
        class="btn-cancel"
        (click)="cancel.emit()"
        [disabled]="isLoading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
          <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
        </svg>
        Volver a Previsualización
      </button>
    </div>
  </div>

  <!-- Test Cases List -->
  <div class="test-cases-list">
    <div class="test-cases-header">
      <h4 class="test-cases-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px; display: inline; margin-right: 0.5rem;">
          <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
        </svg>
        {{ testCases.length }} Casos de Prueba
      </h4>
      <button type="button" class="btn-add-test-case" (click)="addTestCase()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
          <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        Agregar nuevo caso
      </button>
    </div>

    <!-- Empty State -->
    <div class="empty-test-cases" *ngIf="testCases.length === 0">
      <p>No hay casos de prueba. Haz clic en "Agregar nuevo caso" para crear uno.</p>
    </div>

    <!-- Test Case Cards -->
    <div *ngFor="let tc of testCases; let tcIndex = index" 
         class="test-case-card"
         [class.expanded]="tc.isExpanded">
      
      <!-- Card Header -->
      <div class="test-case-header" (click)="toggleTestCaseExpansion(tc, tcIndex)">
        <div class="test-case-header-left">
          <span class="test-case-number">{{ tcIndex + 1 }}</span>
          <span class="test-case-title-preview">{{ tc.title || 'Sin título' }}</span>
        </div>
        <div class="test-case-header-actions" (click)="$event.stopPropagation()">
          <button 
            type="button"
            class="btn-delete-test-case"
            (click)="deleteTestCase(tcIndex)"
            title="Eliminar caso de prueba">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
              <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
            </svg>
          </button>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="expand-icon">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </div>
      </div>

      <!-- Card Content -->
      <div class="test-case-content">
        <form class="test-case-form">
          
          <!-- Title -->
          <div class="form-group">
            <label [for]="'testCaseTitle-' + tcIndex">Título del Caso de Prueba:</label>
            <input
              [id]="'testCaseTitle-' + tcIndex"
              type="text"
              [(ngModel)]="tc.title"
              (ngModelChange)="onTestCaseChange()"
              [name]="'testCaseTitle-' + tcIndex"
              placeholder="Ej: Verificar acceso a la pantalla Ajustes Contables"
              required>
          </div>

          <!-- Preconditions -->
          <div class="form-group">
            <label [for]="'testCasePreconditions-' + tcIndex">Prefacio:</label>
            <textarea
              [id]="'testCasePreconditions-' + tcIndex"
              [(ngModel)]="tc.preconditions"
              (ngModelChange)="onTestCaseChange()"
              [name]="'testCasePreconditions-' + tcIndex"
              placeholder="Condiciones que deben cumplirse antes de ejecutar este caso"
              rows="3"></textarea>
          </div>

          <!-- Steps Section -->
          <div class="steps-section">
            <div class="steps-header">
              <h5>Pasos de Ejecución:</h5>
              <button type="button" class="btn-add-step" (click)="addStep(tc)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                  <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Añadir paso
              </button>
            </div>

            <div class="no-steps" *ngIf="!tc.steps || tc.steps.length === 0">
              No hay pasos definidos. Haz clic en "Añadir paso" para agregar uno.
            </div>

            <div class="steps-list" *ngIf="tc.steps && tc.steps.length > 0">
              <div *ngFor="let step of tc.steps; let stepIndex = index"
                   class="step-item"
                   [class.dragging]="draggedStep === step && draggedStepTestCase === tc"
                   [class.drag-over]="dragOverStepId === (huId + '-tc' + tcIndex + '-step' + stepIndex)"
                   draggable="true"
                   (dragstart)="onStepDragStart($event, step, tc)"
                   (dragover)="onStepDragOver($event, step, tc)"
                   (drop)="onStepDrop($event, step, tc)"
                   (dragleave)="onStepDragLeave($event)"
                   (dragend)="onStepDragEnd($event)">
                
                <div class="step-drag-handle" title="Arrastra para reordenar">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                    <path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd" />
                  </svg>
                </div>

                <span class="step-number">{{ stepIndex + 1 }}</span>

                <div class="step-content">
                  <textarea
                    [(ngModel)]="step.accion"
                    (ngModelChange)="onTestCaseChange()"
                    [name]="'stepAction-tc' + tcIndex + '-step' + stepIndex"
                    placeholder="Describe la acción a realizar en este paso"
                    rows="2"></textarea>
                </div>

                <div class="step-actions">
                  <button 
                    type="button"
                    class="btn-delete-step"
                    (click)="deleteStep(tc, stepIndex)"
                    title="Eliminar paso">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                      <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Expected Results -->
          <div class="form-group">
            <label [for]="'testCaseExpectedResults-' + tcIndex">Resultados esperados:</label>
            <textarea
              [id]="'testCaseExpectedResults-' + tcIndex"
              [(ngModel)]="tc.expectedResults"
              (ngModelChange)="onTestCaseChange()"
              [name]="'testCaseExpectedResults-' + tcIndex"
              placeholder="Describe el resultado esperado al ejecutar todos los pasos"
              rows="3"></textarea>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
