<div class="container">
  <header>
    <h1>Generador de Plan de Pruebas y Escenarios</h1>
  </header>

  <!-- Modal para cargar datos guardados -->
  <div class="storage-prompt-overlay" *ngIf="showLoadDataPrompt">
    <div class="storage-prompt-modal">
      <div class="storage-prompt-header">
        <h3>üíæ Datos Guardados Encontrados</h3>
      </div>
      <div class="storage-prompt-body">
        <p>Se encontraron datos guardados anteriormente. ¬øDeseas cargarlos?</p>
        <div class="storage-info" *ngIf="localStorageService.getStoredStateInfo() as info">
          <p><strong>Historias de Usuario:</strong> {{ info.huCount }}</p>
          <p><strong>√öltima actualizaci√≥n:</strong> {{ info.lastUpdated | date:'medium' }}</p>
        </div>
      </div>
      <div class="storage-prompt-actions">
        <button (click)="loadStoredData()" class="button-primary" [disabled]="loadingFromStorage">
          <span *ngIf="loadingFromStorage" class="spinner-inline"></span>
          Cargar Datos
        </button>
        <button (click)="dismissStoredData()" class="button-secondary" [disabled]="loadingFromStorage">
          Comenzar Desde Cero
        </button>
      </div>
    </div>
  </div>

  <!-- Barra de herramientas de almacenamiento -->
  <section class="storage-toolbar" *ngIf="huList.length > 0">
    <div class="storage-toolbar-content">
      <div class="storage-info-display">
        <span class="storage-icon">üíæ</span>
        <span class="storage-text">Almacenamiento: {{ getStorageInfo() }}</span>
      </div>
      <div class="storage-actions">
        <button (click)="exportBackup()" class="button-secondary button-small" title="Exportar backup como JSON">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 4px;">
            <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
            <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
          </svg>
          Exportar Backup
        </button>
        <label class="button-secondary button-small" style="cursor: pointer;" title="Importar backup desde JSON">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 4px;">
            <path d="M9.25 13.25a.75.75 0 001.5 0V4.636l2.955 3.129a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 101.09 1.03L9.25 4.636v8.614z" />
            <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
          </svg>
          Importar Backup
          <input type="file" accept=".json" (change)="importBackup($event)" style="display: none;">
        </label>
        <button (click)="clearAllData()" class="button-danger button-small" title="Limpiar todos los datos">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 4px;">
            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
          </svg>
          Limpiar Todo
        </button>
      </div>
    </div>
  </section>

  <!-- Sistema de Pesta√±as -->
  <nav class="tabs-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'generate'"
      (click)="switchTab('generate')">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="tab-icon">
        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
      </svg>
      Generar Casos
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'scenarios'"
      [class.has-content]="huList.length > 0"
      (click)="switchTab('scenarios')">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="tab-icon">
        <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm4.5 6.5a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v3.5a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v-3.5z" clip-rule="evenodd" />
      </svg>
      Escenarios de Prueba
      <span class="tab-badge" *ngIf="huList.length > 0">{{ huList.length }}</span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'config'"
      (click)="switchTab('config')">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="tab-icon">
        <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
      </svg>
      Configuraci√≥n del Plan
    </button>
  </nav>

  <!-- Contenido de Pesta√±as -->
  <!-- Contenido de Pesta√±as -->

  <!-- PESTA√ëA 1: GENERAR CASOS -->
  <div class="tab-content" *ngIf="activeTab === 'generate'">
    <section *ngIf="!isModeSelected" class="initial-selection-section" aria-labelledby="welcome-title-main">
      <div class="welcome-text-container">
        <p id="welcome-title-main" class="welcome-subtitle">Agiliza la generaci√≥n de planes de prueba, dise√±os de escenarios y an√°lisis de flujos con IA, alineados con ISTQB.</p>
      </div>
      <h3 id="initial-selection-prompt-title" class="selection-prompt-title">Selecciona un M√©todo de Generaci√≥n</h3>
      <div class="initial-selection-cards-container">
        <div class="mode-card" (click)="selectInitialMode('text')" tabindex="0" role="button" aria-labelledby="mode-card-title-text">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-card-icon"><path d="M3.75 3A1.75 1.75 0 002 4.75v10.5c0 .966.784 1.75 1.75 1.75h12.5A1.75 1.75 0 0018 15.25V4.75A1.75 1.75 0 0016.25 3H3.75zM9 6a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75V6.75A.75.75 0 014.5 6H9zm5.5 0A.75.75 0 0115.25 6.75v.008a.75.75 0 01-.75.75H11a.75.75 0 01-.75-.75V6.75A.75.75 0 0111 6h3.5zM4.5 9.25a.75.75 0 00-.75.75v.008c0 .414.336.75.75.75H11a.75.75 0 00.75-.75V10a.75.75 0 00-.75-.75H4.5zm8.25.75a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v3.5a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-3.5zM9 12.5a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75V13.25a.75.75 0 01.75-.75H9z" /></svg>
          <p id="mode-card-title-text" class="mode-card-title">Por Descripci√≥n de HU y Criterios</p>
          <p class="mode-card-description">Genera alcance y casos de prueba basados en texto y t√©cnicas ISTQB.</p>
        </div>
        <div class="mode-card" (click)="selectInitialMode('image')" tabindex="0" role="button" aria-labelledby="mode-card-title-image">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-card-icon"><path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 013.25 3h13.5A2.25 2.25 0 0119 5.25v9.5A2.25 2.25 0 0116.75 17H3.25A2.25 2.25 0 011 14.75v-9.5zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3.69l-2.72-2.72a.75.75 0 00-1.06 0L11 12.19l-2.47-2.47a.75.75 0 00-1.06 0L1.5 11.06zM9.25 7.5a1.25 1.25 0 112.5 0 1.25 1.25 0 01-2.5 0z" clip-rule="evenodd" /></svg>
          <p id="mode-card-title-image" class="mode-card-title">Casos de Prueba por Im√°genes</p>
          <p class="mode-card-description">Carga im√°genes de UI y aplica una t√©cnica ISTQB para generar casos.</p>
        </div>
      </div>
    </section>

    <ng-container *ngIf="isModeSelected">
      <app-test-case-generator *ngIf="showTestCaseGenerator"
        [initialGenerationMode]="currentGenerationMode!"
        [initialSprint]="'Sprint Actual'"
        (huGenerated)="onHuGeneratedFromChild($event)"
        (generationCancelled)="onGenerationCancelledFromChild()">
      </app-test-case-generator>
    </ng-container>
  </div>

  <!-- PESTA√ëA 2: ESCENARIOS DE PRUEBA -->
  <div class="tab-content" *ngIf="activeTab === 'scenarios'">
    <section class="results-section" *ngIf="huList.length > 0" aria-labelledby="scenarios-title">
      <div class="section-header">
        <h2 id="scenarios-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="title-icon" style="width: 1.2em; height: 1.2em; display: inline; vertical-align: middle; margin-right: 8px;">
            <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V6.85a1.5 1.5 0 00-.44-1.06l-3.35-3.35A1.5 1.5 0 0012.15 2H4.5zm2.5 7a.5.5 0 000 1h5a.5.5 0 000-1h-5zm0 2a.5.5 0 000 1h5a.5.5 0 000-1h-5zm0 2a.5.5 0 000 1h5a.5.5 0 000-1h-5z" clip-rule="evenodd" />
          </svg>
          Escenarios de Prueba Generados ({{ huList.length }})
        </h2>
      </div>

      <div class="hu-list-container">
        <div *ngFor="let hu of huList; let i = index; trackBy: trackHuById" class="hu-card">
          <div class="hu-header">
            <h3>
              <ng-container [ngSwitch]="hu.originalInput.generationMode">
                <ng-container *ngSwitchCase="'text'">HU</ng-container>
                <ng-container *ngSwitchCase="'image'">Set de Im√°genes</ng-container>
              </ng-container>
              {{ hu.id }}: {{ hu.title }}
            </h3>
            <div class="hu-meta">
              <span class="sprint-badge">Sprint: {{ hu.sprint }}</span>
              <span *ngIf="hu.originalInput.generationMode === 'image' && hu.originalInput.imagesBase64" class="mode-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-icon">
                  <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 013.25 3h13.5A2.25 2.25 0 0119 5.25v9.5A2.25 2.25 0 0116.75 17H3.25A2.25 2.25 0 011 14.75v-9.5zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3.69l-2.72-2.72a.75.75 0 00-1.06 0L11 12.19l-2.47-2.47a.75.75 0 00-1.06 0L1.5 11.06zM9.25 7.5a1.25 1.25 0 112.5 0 1.25 1.25 0 01-2.5 0z" clip-rule="evenodd" />
                </svg>
                {{ hu.originalInput.imagesBase64.length }} Imagen(es)
              </span>
              <span *ngIf="hu.originalInput.selectedTechnique" class="mode-indicator" [title]="'T√©cnica: ' + hu.originalInput.selectedTechnique">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-icon">
                  <path fill-rule="evenodd" d="M15.988 3.012A2.25 2.25 0 0013.75 2H6.25a2.25 2.25 0 00-2.238 2.012L4 16.25A2.25 2.25 0 006.25 18h7.5A2.25 2.25 0 0016 15.75l.012-12.738zM6 4.25a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5a.75.75 0 01-.75-.75zm-.75 3.5a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5z" clip-rule="evenodd" />
                </svg>
                {{ hu.originalInput.selectedTechnique }}
              </span>
            </div>
          </div>

          <div class="hu-content">
            <!-- Alcance Generado -->
            <details class="plan-section-details" #scopeDetailsElement [open]="hu.isScopeDetailsOpen" (toggle)="!hu.editingScope && (hu.isScopeDetailsOpen = scopeDetailsElement.open)" *ngIf="hu.originalInput.generationMode === 'text' && hu.generatedScope">
              <summary class="plan-section-summary">
                Alcance
                <span class="summary-indicators">
                  <span *ngIf="hu.loadingScope" class="spinner-small"></span>
                  <span *ngIf="hu.errorScope" class="error-status-icon" title="{{ hu.errorScope }}">‚ö†Ô∏è</span>
                </span>
              </summary>
              <div class="plan-section-content">
                <pre class="generated-text">{{ hu.generatedScope }}</pre>
              </div>
            </details>

            <!-- Casos de Prueba -->
            <details class="plan-section-details" #casesDetailsElement [open]="hu.editingScenariosTestCases || true" (toggle)="!hu.editingScenariosTestCases && (hu.isScenariosDetailsOpen = casesDetailsElement.open)" *ngIf="hu.detailedTestCases && hu.detailedTestCases.length > 0">
              <summary class="plan-section-summary">
                Casos de Prueba ({{ hu.detailedTestCases.length }})
                <span class="summary-indicators">
                  <span *ngIf="hu.loadingScope" class="spinner-small"></span>
                  <span *ngIf="hu.errorScope" class="error-status-icon" title="{{ hu.errorScope }}">‚ö†Ô∏è</span>
                </span>
              </summary>
              <div class="plan-section-content">
                <!-- MODO VISTA PREVIA (TABLA) -->
                <div *ngIf="!hu.editingScenariosTestCases" class="detailed-test-cases-table-container">
                  <table class="detailed-test-cases-table">
                    <thead>
                      <tr>
                        <th>ID Caso</th>
                        <th>Escenario de Prueba (T√≠tulo)</th>
                        <th>Precondiciones</th>
                        <th>Paso a Paso</th>
                        <th>Resultado Esperado</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let tc of hu.detailedTestCases; let j = index">
                        <td>{{ hu.id }}_CP{{ j + 1 }}</td>
                        <td>{{ tc.title }}</td>
                        <td><pre class="table-pre">{{ tc.preconditions }}</pre></td>
                        <td>
                          <ul style="margin: 0; padding-left: 20px; list-style: decimal;" *ngIf="tc.steps && tc.steps.length > 0">
                            <li *ngFor="let step of tc.steps">{{ step.accion }}</li>
                          </ul>
                          <span *ngIf="!tc.steps || tc.steps.length === 0">No hay pasos.</span>
                        </td>
                        <td><pre class="table-pre">{{ tc.expectedResults }}</pre></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- MODO EDICI√ìN (COMPONENTE TEST-CASE-EDITOR) -->
                <div *ngIf="hu.editingScenariosTestCases">
                  <app-test-case-editor
                    [testCases]="hu.detailedTestCases"
                    [huId]="hu.id"
                    [isLoading]="hu.loadingScope ?? false"
                    [refinementTechnique]="hu.refinementTechnique || ''"
                    [userRefinementContext]="hu.refinementContext || ''"
                    [showRefinementControls]="true"
                    (refineWithAI)="handleScenariosRefineWithAI(hu, $event)"
                    (testCasesChanged)="handleScenariosTestCasesChanged(hu, $event)"
                    (cancel)="toggleScenarioEdit(hu)">
                  </app-test-case-editor>
                </div>

                <div class="actions" *ngIf="!hu.editingScenariosTestCases">
                  <button (click)="toggleScenarioEdit(hu)" class="button-edit"
                          [disabled]="hu.loadingScope || !hu.detailedTestCases || hu.detailedTestCases.length === 0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 6px; display: inline;">
                      <path d="M15.98 1.804a1 1 0 00-1.96 0l-.24 1.192a1 1 0 01-.784.785l-1.192.238a1 1 0 000 1.962l1.192.238a1 1 0 01.785.785l.238 1.192a1 1 0 001.962 0l.238-1.192a1 1 0 01.785-.785l1.192-.238a1 1 0 000-1.962l-1.192-.238a1 1 0 01-.785-.785l-.238-1.192zM6.949 5.684a1 1 0 00-1.898 0l-.683 2.051a1 1 0 01-.633.633l-2.051.683a1 1 0 000 1.898l2.051.684a1 1 0 01.633.632l.683 2.051a1 1 0 001.898 0l.683-2.051a1 1 0 01.633-.633l2.051-.683a1 1 0 000-1.898l-2.051-.683a1 1 0 01-.633-.633L6.95 5.684zM13.949 13.684a1 1 0 00-1.898 0l-.184.551a1 1 0 01-.632.633l-.551.183a1 1 0 000 1.898l.551.183a1 1 0 01.633.633l.183.551a1 1 0 001.898 0l.184-.551a1 1 0 01.632-.633l.551-.183a1 1 0 000-1.898l-.551-.184a1 1 0 01-.633-.632l-.183-.551z" />
                    </svg>
                    Refinar con IA / Editar Casos
                  </button>
                  <button (click)="exportExecutionMatrix(hu)" class="button-secondary"
                          [disabled]="!hu.detailedTestCases || hu.detailedTestCases.length === 0">
                    Exportar Matriz (.csv)
                  </button>
                  <button (click)="exportExecutionMatrixToHtml(hu)" class="button-secondary"
                          [disabled]="!hu.detailedTestCases || hu.detailedTestCases.length === 0">
                    Exportar Matriz (.xlsx)
                  </button>
                </div>
              </div>
            </details>
          </div>
        </div>
      </div>
    </section>

    <div class="empty-state" *ngIf="huList.length === 0">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="empty-icon">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <p class="empty-text">No hay escenarios generados a√∫n</p>
      <p class="empty-subtext">Ve a "Generar Casos" para crear tu primer escenario de prueba</p>
    </div>
  </div>

  <!-- PESTA√ëA 3: CONFIGURACI√ìN DEL PLAN -->
  <div class="tab-content" *ngIf="activeTab === 'config'">
    <section class="results-section" aria-labelledby="results-section-title" *ngIf="huList.length > 0">
      <div class="section-header">
        <h2 id="results-section-title">Plan de Pruebas: {{ testPlanTitle || 'Configurar Plan' }}</h2>
      </div>
      
      <div class="hu-list-container">
        <div *ngFor="let hu of huList; trackBy: trackHuById" class="hu-card" [id]="'hu-' + hu.id">
            <div class="hu-header">
              <h3>
                <ng-container [ngSwitch]="hu.originalInput.generationMode">
                    <ng-container *ngSwitchCase="'text'">HU</ng-container>
                    <ng-container *ngSwitchCase="'image'">Set de Im√°genes</ng-container>
                </ng-container>
                {{ hu.id }}: {{ hu.title }}
              </h3>
              <div class="hu-meta">
                <span class="sprint-badge">Sprint: {{ hu.sprint }}</span>
                <span *ngIf="(hu.originalInput.generationMode === 'image') && hu.originalInput.imagesBase64" class="mode-indicator">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-icon"><path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 013.25 3h13.5A2.25 2.25 0 0119 5.25v9.5A2.25 2.25 0 0116.75 17H3.25A2.25 2.25 0 011 14.75v-9.5zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-3.69l-2.72-2.72a.75.75 0 00-1.06 0L11 12.19l-2.47-2.47a.75.75 0 00-1.06 0L1.5 11.06zM9.25 7.5a1.25 1.25 0 112.5 0 1.25 1.25 0 01-2.5 0z" clip-rule="evenodd" /></svg>
                  {{ hu.originalInput.imagesBase64.length }} Imagen(es)
                </span>
                <span *ngIf="(hu.originalInput.generationMode === 'text' || hu.originalInput.generationMode === 'image') && hu.originalInput.selectedTechnique" class="mode-indicator" [title]="'T√©cnica: ' + hu.originalInput.selectedTechnique">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="mode-icon"><path fill-rule="evenodd" d="M15.988 3.012A2.25 2.25 0 0013.75 2H6.25a2.25 2.25 0 00-2.238 2.012L4 16.25A2.25 2.25 0 006.25 18h7.5A2.25 2.25 0 0016 15.75l.012-12.738zM6 4.25a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5a.75.75 0 01-.75-.75zm-.75 3.5a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5z" clip-rule="evenodd" /></svg>
                    {{ hu.originalInput.selectedTechnique }}
                </span>
              </div>
            </div>
    
            <details class="plan-section-details" #scopeDetailsElement [open]="hu.isScopeDetailsOpen" (toggle)="!hu.editingScope && (hu.isScopeDetailsOpen = scopeDetailsElement.open)" *ngIf="hu.originalInput.generationMode === 'text'">
              <summary class="plan-section-summary"> Alcance <span class="summary-indicators"> <span *ngIf="hu.loadingScope" class="spinner-small"></span> <span *ngIf="hu.errorScope" class="error-status-icon" title="{{ hu.errorScope }}">‚ö†Ô∏è</span> </span> </summary>
              <div class="plan-section-content"> <div *ngIf="!hu.editingScope; else editScopeBlock"> <pre class="generated-text">{{ hu.generatedScope || 'No se ha generado alcance.' }}</pre> </div> <ng-template #editScopeBlock> <textarea [(ngModel)]="hu.generatedScope" rows="10" class="scrollable-content"></textarea> </ng-template> <div class="actions"> <button (click)="toggleEdit(hu, 'scope')" class="button-edit"> {{ hu.editingScope ? 'Guardar Alcance' : 'Editar Alcance' }} </button> <button (click)="regenerateScope(hu)" class="button-generate" [disabled]="hu.loadingScope"> <span *ngIf="hu.loadingScope" class="spinner-inline"></span> Regenerar Alcance </button> </div> <div *ngIf="hu.errorScope && !hu.loadingScope" class="validation-error" role="alert">{{hu.errorScope}}</div> </div>
            </details>
    
            <details class="plan-section-details" #scenariosDetailsElement
                    [open]="hu.isScopeDetailsOpen || hu.editingTestCases"
                    (toggle)="!hu.editingTestCases && (hu.isScopeDetailsOpen = scenariosDetailsElement.open)"
                    *ngIf="hu.originalInput.generationMode === 'text' || hu.originalInput.generationMode === 'image'">
              <summary class="plan-section-summary"> Casos de Prueba <span class="summary-indicators"> <span *ngIf="hu.loadingScope" class="spinner-small"></span> <span *ngIf="hu.errorScope && !hu.loadingScope" class="error-status-icon" title="{{ hu.errorScope }}">‚ö†Ô∏è</span> </span> </summary>
              <div class="plan-section-content">
                <div *ngIf="hu.loadingScope" class="loading-message">
                    <span class="spinner-inline"></span> Cargando casos de prueba...
                </div>
                <div *ngIf="!hu.loadingScope && hu.errorScope" class="error-message" role="alert">
                    <p><strong>Error en Casos:</strong> {{ hu.errorScope }}</p>
                     <span *ngIf="hu.detailedTestCases?.[0]?.steps?.[0]?.accion && typeof hu.detailedTestCases?.[0]?.steps?.[0]?.accion === 'string' &&
                                         (hu.detailedTestCases?.[0]?.steps?.[0]?.accion?.toLowerCase()?.includes('api') || hu.detailedTestCases?.[0]?.steps?.[0]?.accion?.toLowerCase()?.includes('error'))">
                                <br><small>Respuesta IA: {{ hu.detailedTestCases?.[0]?.steps?.[0]?.accion }}</small>
                     </span>
                </div>

                <!-- MODO VISTA PREVIA (TABLA) -->
                <div *ngIf="!hu.loadingScope && !hu.errorScope && hu.detailedTestCases && hu.detailedTestCases.length > 0 && !hu.editingTestCases">
                  <div class="detailed-test-cases-table-container">
                    <table class="detailed-test-cases-table">
                      <thead> <tr> <th>ID Caso</th> <th>Escenario de Prueba (T√≠tulo)</th> <th>Precondiciones</th> <th>Paso a Paso</th> <th>Resultado Esperado</th> </tr> </thead>
                      <tbody>
                        <tr *ngFor="let tc of hu.detailedTestCases; let i = index">
                          <td>{{ hu.id }}_CP{{ i + 1 }}</td>
                          <td>{{ tc.title }}</td>
                          <td><pre class="table-pre">{{ tc.preconditions }}</pre></td>
                          <td>
                            <ul style="margin: 0; padding-left: 20px; list-style: decimal;" *ngIf="tc.steps && tc.steps.length > 0"><li *ngFor="let step of tc.steps">{{ step.accion }}</li></ul>
                            <span *ngIf="!tc.steps || tc.steps.length === 0">No hay pasos.</span>
                          </td>
                          <td><pre class="table-pre">{{ tc.expectedResults }}</pre></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- MODO EDICI√ìN (COMPONENTE TEST-CASE-EDITOR) -->
                <div *ngIf="!hu.loadingScope && !hu.errorScope && hu.detailedTestCases && hu.detailedTestCases.length > 0 && hu.editingTestCases">
                  <app-test-case-editor
                    [testCases]="hu.detailedTestCases"
                    [huId]="hu.id"
                    [isLoading]="hu.loadingScope ?? false"
                    [refinementTechnique]="hu.refinementTechnique || ''"
                    [userRefinementContext]="hu.refinementContext || ''"
                    [showRefinementControls]="true"
                    (refineWithAI)="handleConfigRefineWithAI(hu, $event)"
                    (testCasesChanged)="handleConfigTestCasesChanged(hu, $event)"
                    (cancel)="toggleEdit(hu, 'testCases')">
                  </app-test-case-editor>
                </div>

                <div *ngIf="!hu.loadingScope && !hu.errorScope && (!hu.detailedTestCases || hu.detailedTestCases.length === 0)" class="no-content-message">
                    <p>No se generaron casos de prueba o la respuesta fue vac√≠a.</p>
                </div>
    
                <div class="actions" *ngIf="!hu.editingTestCases">
                    <button (click)="toggleEdit(hu, 'testCases')" class="button-edit"
                            [disabled]="hu.loadingScope || !hu.detailedTestCases || hu.detailedTestCases.length === 0">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 6px; display: inline;">
                          <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                        </svg>
                        Editar Casos
                    </button>
                    <button (click)="exportExecutionMatrix(hu)" class="button-secondary"
                            [disabled]="!hu.detailedTestCases || hu.detailedTestCases.length === 0 ||
                                        hu.detailedTestCases[0].title.startsWith('Error') ||
                                        hu.detailedTestCases[0].title === 'Informaci√≥n Insuficiente' ||
                                        hu.detailedTestCases[0].title === 'Refinamiento no posible con el contexto actual' ||
                                        hu.detailedTestCases[0].title === 'Im√°genes no interpretables o t√©cnica no aplicable'">
                        Exportar Matriz (.csv)
                    </button>
                    <button (click)="exportExecutionMatrixToHtml(hu)" class="button-secondary"
                            [disabled]="!hu.detailedTestCases || hu.detailedTestCases.length === 0 ||
                                        hu.detailedTestCases[0].title.startsWith('Error') ||
                                        hu.detailedTestCases[0].title === 'Informaci√≥n Insuficiente' ||
                                        hu.detailedTestCases[0].title === 'Refinamiento no posible con el contexto actual' ||
                                        hu.detailedTestCases[0].title === 'Im√°genes no interpretables o t√©cnica no aplicable'">
                        Exportar Matriz (.xlsx)
                    </button>
                </div>
              </div>
            </details>
        </div>
      </div>
    </section>

    <!-- Secci√≥n de Configuraci√≥n del Plan y Previsualizaci√≥n -->
    <div class="static-plan-sections-container" *ngIf="huList.length > 0">
        <div class="section-header"> <h2>Secciones Generales del Plan</h2> </div>
        <details class="plan-section-details static-block" #repoDetailsElement [open]="editingRepositoryLink || isRepositoryLinkDetailsOpen || loadingRepositoryLinkAI" (toggle)="!editingRepositoryLink && !loadingRepositoryLinkAI && (isRepositoryLinkDetailsOpen = repoDetailsElement.open)">
            <summary class="plan-section-summary">Repositorio Pruebas VSTS <span class="summary-indicators"> <span *ngIf="loadingRepositoryLinkAI" class="spinner-small"></span> <span *ngIf="errorRepositoryLinkAI" class="error-status-icon" title="{{ errorRepositoryLinkAI }}">‚ö†Ô∏è</span> </span></summary>
            <div class="plan-section-content">
                <div *ngIf="!editingRepositoryLink; else editRepositoryLinkBlock"> <pre class="static-text"> <a [href]="repositoryLink.split(' ')[0]" target="_blank" rel="noopener noreferrer">{{ repositoryLink }}</a> </pre> </div>
                <ng-template #editRepositoryLinkBlock> <textarea [(ngModel)]="repositoryLink" rows="2" class="scrollable-content"></textarea> </ng-template>
                <div *ngIf="errorRepositoryLinkAI && !loadingRepositoryLinkAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorRepositoryLinkAI}}</div>
                <div class="actions"> <button (click)="toggleStaticEdit('repositoryLink')" class="button-secondary" [disabled]="loadingRepositoryLinkAI"> {{ editingRepositoryLink ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('repositoryLink')" class="button-generate" [disabled]="loadingRepositoryLinkAI || editingRepositoryLink"> <span *ngIf="loadingRepositoryLinkAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
        <details class="plan-section-details static-block" #outOfScopeDetailsElement [open]="editingOutOfScope || isOutOfScopeDetailsOpen || loadingOutOfScopeAI" (toggle)="!editingOutOfScope && !loadingOutOfScopeAI && (isOutOfScopeDetailsOpen = outOfScopeDetailsElement.open)">
            <summary class="plan-section-summary"> Fuera del Alcance <span class="summary-indicators"> <span *ngIf="loadingOutOfScopeAI" class="spinner-small"></span> <span *ngIf="errorOutOfScopeAI" class="error-status-icon" title="{{ errorOutOfScopeAI }}">‚ö†Ô∏è</span> </span> </summary>
            <div class="plan-section-content">
                <div *ngIf="!editingOutOfScope; else editOutOfScopeBlock"> <pre class="static-text">{{ outOfScopeContent }}</pre> </div>
                <ng-template #editOutOfScopeBlock> <textarea [(ngModel)]="outOfScopeContent" rows="4" class="scrollable-content"></textarea> </ng-template>
                <div *ngIf="errorOutOfScopeAI && !loadingOutOfScopeAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorOutOfScopeAI}}</div>
                <div class="actions"> <button (click)="toggleStaticEdit('outOfScope')" class="button-secondary" [disabled]="loadingOutOfScopeAI"> {{ editingOutOfScope ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('outOfScope')" class="button-generate" [disabled]="loadingOutOfScopeAI || editingOutOfScope"> <span *ngIf="loadingOutOfScopeAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
        <details class="plan-section-details static-block" #strategyDetailsElement [open]="editingStrategy || isStrategyDetailsOpen || loadingStrategyAI" (toggle)="!editingStrategy && !loadingStrategyAI && (isStrategyDetailsOpen = strategyDetailsElement.open)">
            <summary class="plan-section-summary"> Estrategia <span class="summary-indicators"> <span *ngIf="loadingStrategyAI" class="spinner-small"></span> <span *ngIf="errorStrategyAI" class="error-status-icon" title="{{ errorStrategyAI }}">‚ö†Ô∏è</span> </span> </summary>
            <div class="plan-section-content">
                <div *ngIf="!editingStrategy; else editStrategyBlock"> <pre class="static-text">{{ strategyContent }}</pre> </div>
                <ng-template #editStrategyBlock> <textarea [(ngModel)]="strategyContent" rows="8" class="scrollable-content"></textarea> </ng-template>
                <div *ngIf="errorStrategyAI && !loadingStrategyAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorStrategyAI}}</div>
                <div class="actions"> <button (click)="toggleStaticEdit('strategy')" class="button-secondary" [disabled]="loadingStrategyAI"> {{ editingStrategy ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('strategy')" class="button-generate" [disabled]="loadingStrategyAI || editingStrategy"> <span *ngIf="loadingStrategyAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
        <details class="plan-section-details static-block" #limitationsDetailsElement [open]="editingLimitations || isLimitationsDetailsOpen || loadingLimitationsAI" (toggle)="!editingLimitations && !loadingLimitationsAI && (isLimitationsDetailsOpen = limitationsDetailsElement.open)">
            <summary class="plan-section-summary"> Limitaciones <span class="summary-indicators"> <span *ngIf="loadingLimitationsAI" class="spinner-small"></span> <span *ngIf="errorLimitationsAI" class="error-status-icon" title="{{ errorLimitationsAI }}">‚ö†Ô∏è</span> </span> </summary>
            <div class="plan-section-content">
                <div *ngIf="!editingLimitations; else editLimitationsBlock"> <pre class="static-text">{{ limitationsContent }}</pre> </div>
                <ng-template #editLimitationsBlock> <textarea [(ngModel)]="limitationsContent" rows="4" class="scrollable-content"></textarea> </ng-template>
                <div *ngIf="errorLimitationsAI && !loadingLimitationsAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorLimitationsAI}}</div>
                <div class="actions"> <button (click)="toggleStaticEdit('limitations')" class="button-secondary" [disabled]="loadingLimitationsAI"> {{ editingLimitations ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('limitations')" class="button-generate" [disabled]="loadingLimitationsAI || editingLimitations"> <span *ngIf="loadingLimitationsAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
        <details class="plan-section-details static-block" #assumptionsDetailsElement
                 [open]="editingAssumptions || isAssumptionsDetailsOpen || loadingAssumptionsAI"
                 (toggle)="!editingAssumptions && !loadingAssumptionsAI && (isAssumptionsDetailsOpen = assumptionsDetailsElement.open)">
            <summary class="plan-section-summary"> Supuestos <span class="summary-indicators"> <span *ngIf="loadingAssumptionsAI" class="spinner-small"></span> <span *ngIf="errorAssumptionsAI" class="error-status-icon" title="{{ errorAssumptionsAI }}">‚ö†Ô∏è</span> </span> </summary>
            <div class="plan-section-content">
              <div *ngIf="!editingAssumptions; else editAssumptionsBlock"> <pre class="static-text">{{ assumptionsContent }}</pre> </div>
              <ng-template #editAssumptionsBlock> <textarea [(ngModel)]="assumptionsContent" rows="8" class="scrollable-content"></textarea> </ng-template>
              <div *ngIf="errorAssumptionsAI && !loadingAssumptionsAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorAssumptionsAI}}</div>
              <div class="actions"> <button (click)="toggleStaticEdit('assumptions')" class="button-secondary" [disabled]="loadingAssumptionsAI"> {{ editingAssumptions ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('assumptions')" class="button-generate" [disabled]="loadingAssumptionsAI || editingAssumptions"> <span *ngIf="loadingAssumptionsAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
        <details class="plan-section-details static-block" #teamDetailsElement [open]="editingTeam || isTeamDetailsOpen || loadingTeamAI" (toggle)="!editingTeam && !loadingTeamAI && (isTeamDetailsOpen = teamDetailsElement.open)">
            <summary class="plan-section-summary">Equipo de Trabajo <span class="summary-indicators"> <span *ngIf="loadingTeamAI" class="spinner-small"></span> <span *ngIf="errorTeamAI" class="error-status-icon" title="{{ errorTeamAI }}">‚ö†Ô∏è</span> </span></summary>
            <div class="plan-section-content">
              <div *ngIf="!editingTeam; else editTeamBlock"> <pre class="static-text">{{ teamContent }}</pre> </div>
              <ng-template #editTeamBlock> <textarea [(ngModel)]="teamContent" rows="8" class="scrollable-content"></textarea> </ng-template>
              <div *ngIf="errorTeamAI && !loadingTeamAI" class="validation-error" role="alert" style="margin-top: 10px;">{{errorTeamAI}}</div>
              <div class="actions"> <button (click)="toggleStaticEdit('team')" class="button-secondary" [disabled]="loadingTeamAI"> {{ editingTeam ? 'Guardar' : 'Editar' }} </button> <button (click)="regenerateStaticSectionWithAI('team')" class="button-generate" [disabled]="loadingTeamAI || editingTeam"> <span *ngIf="loadingTeamAI" class="spinner-inline"></span> Mejorar con IA </button> </div>
            </div>
        </details>
    
    <!-- Secci√≥n de Previsualizaci√≥n dentro del mismo contenedor -->
    <div class="preview-section" *ngIf="downloadPreviewHtmlContent">
      <h2>Previsualizaci√≥n del Plan Descargable (.doc)</h2>
      <pre class="download-preview" [innerHTML]="downloadPreviewHtmlContent"></pre>
    </div>

    <div class="download-actions-container">
        <button (click)="copyPreviewToClipboard()" class="button-secondary" [disabled]="huList.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 8px;"><path d="M7 3.5A1.5 1.5 0 018.5 2h3.879a1.5 1.5 0 011.06.44l3.122 3.121A1.5 1.5 0 0117 6.621V16.5A1.5 1.5 0 0115.5 18H8.5A1.5 1.5 0 017 16.5v-13z" /><path d="M5 6.5A1.5 1.5 0 016.5 5h3A1.5 1.5 0 0011 3.5V2A1.5 1.5 0 009.5 3.5v10A1.5 1.5 0 0011 15v1.5A1.5 1.5 0 009.5 15h-3A1.5 1.5 0 015 13.5v-7z" /></svg>
          Copiar Texto del Plan
        </button>
        <button (click)="downloadWord()" class="button-primary button-download" [disabled]="huList.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1em; height: 1em; margin-right: 8px;"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm5 6.5a.75.75 0 00-1.5 0v3.546l-1.073-1.073a.75.75 0 10-1.06 1.06l2.25 2.25a.75.75 0 001.06 0l2.25-2.25a.75.75 0 10-1.06-1.06L10.25 12.046V8.5z" clip-rule="evenodd" /></svg>
          Descargar Plan Completo (.doc)
        </button>
    </div>
  </div>

    <div class="empty-state" *ngIf="huList.length === 0">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="empty-icon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
      <p class="empty-text">No hay configuraci√≥n disponible</p>
      <p class="empty-subtext">Genera escenarios de prueba primero para configurar el plan</p>
    </div>
  </div>

</div>
<app-html-matrix-exporter #matrixExporter></app-html-matrix-exporter>

