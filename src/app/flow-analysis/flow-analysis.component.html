<div *ngIf="componentState !== 'displayingReport'" class="form-section" aria-labelledby="flow-analysis-main-title">
  
  <div class="form-header-actions">
    <h2 id="flow-analysis-main-title">
      <span *ngIf="componentState === 'form'">Datos de Entrada para Análisis de Flujo</span>
      <span *ngIf="componentState === 'guidedAnalysis'">Análisis Guiado de Flujo (Paso {{ currentStepIndex + 1 }} de {{ draggableImages.length }})</span>
      <span *ngIf="componentState === 'finalizingReport'">Finalizando y Generando Reporte...</span>
    </h2>
    <button type="button" (click)="handleCancelFlowForm()" class="button-secondary button-small" [disabled]="loadingFlowAnalysis || isSubmitting">Cancelar</button>
  </div>

  <form (ngSubmit)="startGuidedAnalysis()" #flowAnalysisForm="ngForm" *ngIf="componentState === 'form'">
    <div class="form-grid">
        <div class="form-group">
            <label for="flowCurrentIdAnLocal">ID (Generado desde Título):</label> 
            <input id="flowCurrentIdAnLocal" type="text" name="flowCurrentIdAnLocal" [value]="generateIdFromTitle(currentFlowTitle)" readonly placeholder="Se genera desde el título" class="form-control">
        </div>
        <div class="form-group">
            <label for="flowCurrentTitleAnLocal">Título del Análisis de Flujo:<span class="required-indicator">*</span></label> 
            <input id="flowCurrentTitleAnLocal" type="text" name="currentFlowTitle" [(ngModel)]="currentFlowTitle" required placeholder="Título descriptivo" class="form-control" #currentFlowTitleCtrl="ngModel">
            <div *ngIf="currentFlowTitleCtrl.invalid && (currentFlowTitleCtrl.dirty || currentFlowTitleCtrl.touched || flowAnalysisForm.submitted)" class="validation-error" role="alert">
                El título es requerido.
            </div>
        </div>
        <div class="form-group">
            <label for="flowCurrentSprintAnLocal">Sprint:<span class="required-indicator">*</span></label> 
            <input id="flowCurrentSprintAnLocal" type="text" name="currentFlowSprint" [(ngModel)]="currentFlowSprint" required placeholder="Ej: Sprint 1" class="form-control" #currentFlowSprintCtrl="ngModel">
            <div *ngIf="currentFlowSprintCtrl.invalid && (currentFlowSprintCtrl.dirty || currentFlowSprintCtrl.touched || flowAnalysisForm.submitted)" class="validation-error" role="alert">
                Sprint es requerido.
            </div>
        </div>
        <div class="form-group full-width">
          <label for="flowAnalysisImagesInputLocal">Cargar Imágenes del Flujo (JPG, PNG - Máx. 4MB c/u, Máx. 20):<span class="required-indicator">*</span></label>
          <input type="file" id="flowAnalysisImagesInputLocal" name="flowAnalysisImages" (change)="onFileSelected($event)" accept="image/jpeg, image/png" multiple #flowAnalysisImageInput>
          <div *ngIf="imageUploadError" class="validation-error" role="alert">{{ imageUploadError }}</div>
          <div *ngIf="flowAnalysisForm.submitted && draggableImages.length === 0" class="validation-error" role="alert">
            Debes seleccionar al menos una imagen.
          </div>
          
          <div *ngIf="draggableImages.length > 0" class="image-preview-container multiple-previews" (dragover)="onImageDragOver($event)" (dragleave)="onImageDragLeave($event)">
            <p>Imágenes del Flujo ({{ draggableImages.length }}). Arrastra para reordenar.</p>
            <div *ngFor="let imgItem of draggableImages; let i = index" class="image-preview-item" [class.drag-over-element]="dragOverImageId === imgItem.id" draggable="true" (dragstart)="onImageDragStart($event, imgItem)" (drop)="onImageDrop($event, imgItem)" (dragend)="onImageDragEnd($event)" (dragover)="onImageDragOver($event, imgItem)">
              <span class="image-order-badge">{{i + 1}}</span>
              <img [src]="imgItem.preview" [alt]="'Previsualización ' + imgItem.file.name" class="image-preview">
              <span class="image-filename" title="{{ imgItem.file.name }}">{{ imgItem.file.name }}</span>
            </div>
          </div>
        </div>
    </div>
    <div class="form-actions">
      <button type="submit" class="button-primary" [disabled]="isFormInvalid()">
        Iniciar Análisis Guiado
      </button>
    </div>
    <div *ngIf="formError" class="error-message" role="alert"><p>{{ formError }}</p></div>
  </form>

  <div *ngIf="componentState === 'guidedAnalysis' && guidedStepsContext[currentStepIndex]">
    <div class="guided-analysis-container">
      <div class="progress-timeline">
        <div *ngFor="let step of guidedStepsContext; let i = index" class="timeline-step" [ngClass]="{'active': i === currentStepIndex, 'completed': i < currentStepIndex}">
          <div class="timeline-circle">{{ i + 1 }}</div>
          <div class="timeline-label">Paso {{ i + 1 }}</div>
        </div>
      </div>
      <div class="step-content-grid">
        <div class="step-image-container">
          <h4>Imagen del Paso Actual</h4>
          <img [src]="guidedStepsContext[currentStepIndex].image.annotatedPreview || guidedStepsContext[currentStepIndex].image.preview" alt="Imagen del paso {{currentStepIndex + 1}}">
        </div>
        <div class="step-context-container">
          <h4>Contexto y Acciones</h4>
          <div *ngIf="isCurrentStepAiLoading" class="loading-message"><span class="spinner"></span>Analizando imagen con IA...</div>
          <div *ngIf="!isCurrentStepAiLoading">
            <div class="form-group">
              <label for="ai-description">Descripción de la Pantalla (Sugerida por IA):</label>
              <textarea id="ai-description" class="form-control" rows="3" [(ngModel)]="currentStepUserDescription" placeholder="Describe el propósito de esta pantalla."></textarea>
            </div>
            <div class="form-group">
                <p><strong>Elementos Clave Identificados por IA:</strong></p>
                <ul *ngIf="currentStepAiAnalysis?.elements?.length" class="ai-elements-list">
                    <li *ngFor="let el of currentStepAiAnalysis?.elements">{{el.element}} ({{el.type}})</li>
                </ul>
                <p *ngIf="!currentStepAiAnalysis?.elements?.length" class="no-annotations-message" style="font-size: 0.9em; padding: 10px;">La IA no identificó elementos o el análisis está pendiente.</p>
            </div>
            <div class="form-group">
                <p><strong>Anotaciones del Usuario (para este paso):</strong></p>
                <p class="annotation-instructions">Usa el editor para marcar la **acción de disparo** (el clic que lleva al siguiente paso), los **datos de entrada** y cualquier **punto de verificación** importante en esta pantalla.</p>
                <button type="button" class="button-edit" (click)="openImageEditorForCurrentStep()">
                    <span *ngIf="guidedStepsContext[currentStepIndex].annotations.length === 0">Añadir/Editar Anotaciones</span>
                    <span *ngIf="guidedStepsContext[currentStepIndex].annotations.length > 0">Editar Anotaciones ({{ guidedStepsContext[currentStepIndex].annotations.length }})</span>
                </button>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="stepValidationError" class="validation-error" style="text-align:center; margin-top:15px;" role="alert">{{ stepValidationError }}</div>
      <div class="step-navigation-actions">
        <button type="button" (click)="goToPreviousStep()" class="button-secondary" [disabled]="currentStepIndex === 0 || isCurrentStepAiLoading">Anterior</button>
        <button type="button" (click)="goToNextStep()" class="button-primary" [disabled]="isCurrentStepAiLoading">
          {{ isLastStep() ? 'Finalizar y Generar Reporte' : 'Siguiente Paso' }}
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="componentState === 'finalizingReport'" class="loading-message">
    <span class="spinner"></span>
    <p>Todos los pasos han sido analizados. Generando el informe final, por favor espera...</p>
  </div>
</div>

<div *ngIf="componentState === 'displayingReport' && generatedAnalysisData && generatedAnalysisData.flowAnalysisReport as reports" class="flow-analysis-results" aria-labelledby="flow-analysis-report-title">
  
  <div *ngIf="reports[0] as report">
    <div class="form-header-actions">
      <h2 id="flow-analysis-report-title">Informe de Análisis de Flujo: {{ generatedAnalysisData.title }}</h2>
      <div>
        <button type="button" (click)="resetToForm()" class="button-secondary button-small">Generar Otro Análisis</button>
        <button type="button" (click)="confirmAndAddToPlan()" class="button-primary button-small" [disabled]="isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-inline"></span>
          {{ isSubmitting ? 'Enviando...' : 'Confirmar y Añadir al Plan' }}
        </button>
      </div>
    </div>

    <div *ngIf="flowAnalysisError" class="error-message" role="alert">
      <p><strong>Error en el Análisis:</strong> {{ flowAnalysisError }}</p>
    </div>

    <div *ngIf="!isFlowAnalysisReportInErrorState(report)">
      <div class="report-detail-group">
        <label>Nombre del Escenario</label>
        <div class="report-field">{{ report.Nombre_del_Escenario }}</div>
      </div>

      <div class="report-detail-group">
        <label>Pasos Analizados (Arrastra las filas para reordenar)</label>
        <div class="detailed-test-cases-table-container">
          <table class="detailed-test-cases-table flow-analysis-steps-table">
            <thead>
              <tr>
                <th>Paso N°</th>
                <th>Acción/Observación</th>
                <th>Imagen Ref. (IA)</th>
                <th>Elemento Clave</th>
                <th>Dato Entrada</th>
                <th>Res. Esperado</th>
                <th>Res. Obtenido y Estado</th>
                <th>Imagen Paso</th>
              </tr>
            </thead>
            <tbody (dragover)="onStepDragOver($event)" (dragleave)="onStepDragLeave($event)">
              <tr *ngFor="let paso of report.Pasos_Analizados; let i = index" 
                  [ngClass]="getFlowStepStatusClass(paso)"
                  draggable="true"
                  (dragstart)="onStepDragStart($event, paso)"
                  (drop)="onStepDrop($event, paso)"
                  (dragend)="onStepDragEnd($event)"
                  (dragover)="onStepDragOver($event, paso)"
                  [class.drag-over-element]="dragOverFlowStepId === (generatedAnalysisData.id + '-' + paso.numero_paso)">
                <td>{{ paso.numero_paso }}</td>
                <td>{{ paso.descripcion_accion_observada }}</td>
                <td>{{ paso.imagen_referencia_entrada }}</td>
                <td>{{ paso.elemento_clave_y_ubicacion_aproximada }}</td>
                <td>{{ paso.dato_de_entrada_paso || 'N/A' }}</td>
                <td>{{ paso.resultado_esperado_paso }}</td>
                <td>{{ paso.resultado_obtenido_paso_y_estado }}</td>
                <td class="image-cell">
                  <img *ngIf="getFlowStepImage(generatedAnalysisData, paso)" 
                       [src]="getFlowStepImage(generatedAnalysisData, paso)" 
                       [alt]="'Imagen para paso ' + paso.numero_paso" 
                       class="flow-step-image"
                       (click)="openImageInNewTab(paso.imagen_referencia_entrada)">
                  <span *ngIf="!getFlowStepImage(generatedAnalysisData, paso)">N/A</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="report-detail-group">
        <label>Resultado Esperado General del Flujo</label>
        <div class="report-field">{{ report.Resultado_Esperado_General_Flujo }}</div>
      </div>

      <div class="report-detail-group">
        <label>Conclusión General del Flujo (Generada por IA)</label>
        <div class="report-field">{{ report.Conclusion_General_Flujo }}</div>
      </div>
      
      <div class="actions">
        <button (click)="refineFlowAnalysisReport()" class="button-generate" [disabled]="loadingFlowAnalysis">
            <span *ngIf="loadingFlowAnalysis" class="spinner-inline"></span>Re-Analizar Flujo
        </button>
        <button (click)="exportFlowAnalysisReportToHtmlLocalized('es')" class="button-secondary">Exportar Informe ESP (.html)</button>
        <button (click)="exportFlowAnalysisReportToHtmlLocalized('en')" class="button-secondary">Exportar Informe ENG (.html)</button>
        <button (click)="exportFlowAnalysisReportToCsv()" class="button-secondary">Exportar Datos (.csv)</button>
      </div>
    </div>
  </div>
</div>

<app-image-annotation-editor
  *ngIf="showImageEditor"
  [imageUrl]="imageToEditUrl"
  [existingAnnotations]="existingAnnotationsForEditor"
  [currentImageFilename]="imageBeingEditedObject?.file?.name || 'imagen_desconocida.png'"
  [imageMimeType]="imageBeingEditedObject?.mimeType"
  (annotationsApplied)="onAnnotationsApplied($event)"
  (editorClosed)="closeImageEditor()">
</app-image-annotation-editor>