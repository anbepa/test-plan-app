<!-- src/app/test-case-generator/test-case-generator.component.html -->
<div class="form-section" aria-labelledby="test-case-form-section-title">
  <div class="form-header-actions">
    <h2 id="test-case-form-section-title">
      Datos de Entrada para:
      <span *ngIf="currentGenerationMode === 'text'">HU por Descripción</span>
      <span *ngIf="currentGenerationMode === 'image'">Casos por Imágenes</span>
    </h2>
    <button type="button" (click)="cancelGeneration()" class="button-secondary button-small">Cancelar y Cambiar Método</button>
  </div>

  <form (ngSubmit)="addHuAndGenerateData()" #huForm="ngForm" *ngIf="!generatedHUData">
    <div class="form-grid">
      <!-- Campos para modo 'text' -->
      <ng-container *ngIf="currentGenerationMode === 'text'">
        <div class="form-group">
          <label for="tcCurrentHuIdText">ID de la HU:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuIdText" type="text" name="currentHuId" [(ngModel)]="currentHuId" required placeholder="Ej: HU_1234" class="form-control">
          <div *ngIf="huForm.controls['currentHuId']?.invalid && (huForm.controls['currentHuId']?.dirty || huForm.controls['currentHuId']?.touched || huForm.submitted)" class="validation-error" role="alert">
            ID de la HU es requerido.
          </div>
        </div>
        <div class="form-group">
          <label for="tcCurrentHuTitleText">Título de la HU:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuTitleText" type="text" name="currentHuTitle" [(ngModel)]="currentHuTitle" required placeholder="Ej: Como usuario, quiero..." class="form-control">
          <div *ngIf="huForm.controls['currentHuTitle']?.invalid && (huForm.controls['currentHuTitle']?.dirty || huForm.controls['currentHuTitle']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Título de la HU es requerido.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcCurrentDescription">Descripción de la HU:<span class="required-indicator">*</span></label>
          <textarea id="tcCurrentDescription" name="currentDescription" [(ngModel)]="currentDescription" rows="4" required placeholder="Ej: La HU describe la funcionalidad..." class="form-control"></textarea>
          <div *ngIf="huForm.controls['currentDescription']?.invalid && (huForm.controls['currentDescription']?.dirty || huForm.controls['currentDescription']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Descripción de la HU es requerida.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcCurrentAcceptanceCriteria">Criterios de Aceptación:<span class="required-indicator">*</span></label>
          <textarea id="tcCurrentAcceptanceCriteria" name="currentAcceptanceCriteria" [(ngModel)]="currentAcceptanceCriteria" rows="6" required placeholder="Ej: - Dado que..." class="form-control"></textarea>
          <div *ngIf="huForm.controls['currentAcceptanceCriteria']?.invalid && (huForm.controls['currentAcceptanceCriteria']?.dirty || huForm.controls['currentAcceptanceCriteria']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Criterios de Aceptación son requeridos.
          </div>
        </div>
      </ng-container>

      <!-- Campos para modo 'image' -->
      <ng-container *ngIf="currentGenerationMode === 'image'">
        <div class="form-group">
          <label for="tcCurrentHuIdImage">ID (Generado desde Título):</label>
          <input id="tcCurrentHuIdImage" type="text" name="currentHuIdGenerated" [value]="generateIdFromTitle(currentHuTitle, currentGenerationMode)" readonly placeholder="Se genera desde el título" class="form-control">
        </div>
        <div class="form-group">
          <label for="tcCurrentHuTitleImage">Título del Conjunto de Imágenes:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuTitleImage" type="text" name="currentHuTitle" [(ngModel)]="currentHuTitle" required placeholder="Título descriptivo del set de imágenes" class="form-control">
          <div *ngIf="huForm.controls['currentHuTitle']?.invalid && (huForm.controls['currentHuTitle']?.dirty || huForm.controls['currentHuTitle']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Título es requerido.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcImageFiles">Cargar Imágenes (JPG, PNG - Máx. 4MB c/u, Máx. 5):<span class="required-indicator">*</span></label>
          <input type="file" id="tcImageFiles" name="imageFiles" (change)="onFileSelected($event)" accept="image/jpeg, image/png"
                 multiple #imageFilesInput>
          <div *ngIf="imageUploadError" class="validation-error" role="alert">{{ imageUploadError }}</div>
          <div *ngIf="huForm.submitted && draggableImages.length === 0 && currentGenerationMode === 'image'" class="validation-error" role="alert">
            Debes seleccionar al menos una imagen.
          </div>

          <div *ngIf="draggableImages.length > 0" class="image-preview-container multiple-previews"
               (dragover)="onImageDragOver($event)" (dragleave)="onImageDragLeave($event)">
            <p>Previsualización ({{ draggableImages.length }}). Arrastra para reordenar:</p>
            <div *ngFor="let imgItem of draggableImages; let i = index"
                 class="image-preview-item" [class.drag-over-element]="dragOverImageId === imgItem.id"
                 draggable="true" (dragstart)="onImageDragStart($event, imgItem)"
                 (drop)="onImageDrop($event, imgItem)" (dragend)="onImageDragEnd($event)"
                 (dragover)="onImageDragOver($event, imgItem)">
              <span class="image-order-badge">{{i + 1}}</span>
              <img [src]="imgItem.preview" [alt]="'Previsualización ' + imgItem.file.name" class="image-preview">
              <span class="image-filename" title="{{ imgItem.file.name }}">{{ imgItem.file.name }}</span>
            </div>
          </div>
        </div>
      </ng-container>

      <div class="form-group">
        <label for="tcCurrentSprint">Sprint:<span class="required-indicator">*</span></label>
        <input id="tcCurrentSprint" type="text" name="currentSprint" [(ngModel)]="currentSprint" required placeholder="Ej: Sprint 1" class="form-control">
        <div *ngIf="huForm.controls['currentSprint']?.invalid && (huForm.controls['currentSprint']?.dirty || huForm.controls['currentSprint']?.touched || huForm.submitted)" class="validation-error" role="alert">
          Sprint es requerido.
        </div>
      </div>

      <div class="form-group">
        <label for="tcCurrentSelectedTechnique">Técnica ISTQB para escenarios:<span class="required-indicator">*</span></label>
        <select id="tcCurrentSelectedTechnique" name="currentSelectedTechnique" [(ngModel)]="currentSelectedTechnique" required class="form-control">
          <option value="" disabled>Selecciona una técnica</option>
          <option value="Equivalent Partitioning">Partición Equivalente</option>
          <option value="Boundary Value Analysis">Análisis de Valor Límite</option>
          <option value="Decision Table Testing">Tabla de Decisión</option>
          <option value="State Transition Testing">Pruebas de Transición de Estados</option>
        </select>
        <div *ngIf="huForm.controls['currentSelectedTechnique']?.invalid && (huForm.controls['currentSelectedTechnique']?.dirty || huForm.controls['currentSelectedTechnique']?.touched || huForm.submitted)" class="validation-error" role="alert">
          Debes seleccionar una técnica ISTQB.
        </div>
      </div>
    </div>

    <div class="form-actions main-form-actions">
      <button type="submit" class="button-primary full-width-action" [disabled]="isFormInvalidForCurrentMode() || loadingScope || loadingScenarios">
        <span *ngIf="loadingScope || loadingScenarios" class="spinner"></span>
        {{ (loadingScope || loadingScenarios) ? 'Generando...' : 'Generar Casos de Prueba' }}
      </button>
    </div>
  </form>

  <div *ngIf="generatedHUData as data"> 
      <div *ngIf="errorScope && data.originalInput.generationMode === 'text' || errorScenarios" class="error-message generated-data-error" role="alert">
          <p *ngIf="errorScope && data.originalInput.generationMode === 'text'">Error en Alcance: {{ errorScope }}</p>
          <p *ngIf="errorScenarios">Error en Escenarios: {{ errorScenarios }}</p>
      </div>
  </div>
  <div *ngIf="!generatedHUData && formError" class="error-message initial-form-error" role="alert">
      <p>{{formError}}</p>
  </div>


  <div *ngIf="generatedHUData as data">
    <div *ngIf="!errorScenarios || (data.detailedTestCases && data.detailedTestCases.length > 0 && data.detailedTestCases[0].title !== 'Información Insuficiente' && data.detailedTestCases[0].title !== 'Imágenes no interpretables o técnica no aplicable' && !data.detailedTestCases[0].title?.startsWith('Error'))" class="generated-test-cases-editor">
        <h3>Casos de Prueba Generados para: {{ data.title }}</h3>
        
        <div *ngIf="data.originalInput.generationMode === 'text'" class="scope-display-section">
        <strong>Alcance Generado:</strong>
        <pre>{{ data.generatedScope || 'No se pudo generar el alcance o no aplica.' }}</pre>
        </div>


        <div *ngFor="let tc of data.detailedTestCases; let tcIndex = index" class="test-case-edit-card">
        <h4>
            <span>Caso de Prueba #{{ tcIndex + 1 }}:</span>
            <input type="text" class="form-control inline-edit" [(ngModel)]="tc.title" placeholder="Título del Caso de Prueba">
        </h4>
        <div class="form-group">
            <label for="tcPreconditions-{{data.id}}-{{tcIndex}}">Precondiciones:</label>
            <textarea id="tcPreconditions-{{data.id}}-{{tcIndex}}" class="form-control" [(ngModel)]="tc.preconditions" rows="2"></textarea>
        </div>

        <h5>Pasos del Caso de Prueba:</h5>
        <div class="detailed-test-cases-table-container"
            (dragover)="onTestCaseStepDragOver($event, tc.steps && tc.steps.length > 0 ? tc.steps[0] : undefined, tc)" 
            (dragleave)="onTestCaseStepDragLeave($event)">
            <table class="detailed-test-cases-table test-case-steps-table">
            <thead>
                <tr>
                <th style="width: 10%;">Paso N°</th>
                <th style="width: 75%;">Acción</th>
                <th style="width: 15%; text-align: center;">Eliminar</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let step of tc.steps; let stepIndex = index"
                    [attr.draggable]="true"
                    (dragstart)="onTestCaseStepDragStart($event, step, tc)"
                    (drop)="onTestCaseStepDrop($event, step, tc)"
                    (dragend)="onTestCaseStepDragEnd($event)"
                    (dragover)="onTestCaseStepDragOver($event, step, tc)"
                    (dragleave)="onTestCaseStepDragLeave($event)"
                    [class.drag-over-element]="dragOverTestCaseStepId === getTestCaseStepDragId(tc, step)">
                <td>{{ step.numero_paso }}</td>
                <td>
                    <textarea class="form-control table-input" [(ngModel)]="step.accion" rows="1" placeholder="Descripción del paso"
                              (input)="autoGrowTextarea($event.target)"></textarea> <!-- Directiva o función para auto-crecimiento -->
                </td>
                <td class="action-cell">
                    <button (click)="deleteTestCaseStep(tc, stepIndex)" class="button-cancel button-small-icon delete-step-button" title="Eliminar Paso">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75H4.5a.75.75 0 000 1.5h11a.75.75 0 000-1.5H14A2.75 2.75 0 0011.25 1H8.75zM10 4.75a.75.75 0 01.75.75V15.5a.75.75 0 01-1.5 0V5.5A.75.75 0 0110 4.75zM7.515 7.31l-.53 7.422a.75.75 0 101.49.107l.53-7.422a.75.75 0 00-1.49-.107zM12.485 7.31a.75.75 0 00-1.49.107l.53 7.422a.75.75 0 101.49-.107l-.53-7.422z" clip-rule="evenodd" /></svg>
                    </button>
                </td>
                </tr>
                <tr *ngIf="!tc.steps || tc.steps.length === 0">
                    <td colspan="3" style="text-align: center; font-style: italic;">No hay pasos definidos. Haz clic en el botón '+' para añadir uno.</td>
                </tr>
            </tbody>
            </table>
        </div>
        <div class="add-step-action-container"> <!-- Contenedor para el botón Añadir Paso -->
            <button type="button" (click)="addTestCaseStep(tc)" class="button-secondary button-small-icon add-step-button" title="Añadir Paso">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                Añadir Paso
            </button>
        </div>

        <div class="form-group">
            <label for="tcExpectedResults-{{data.id}}-{{tcIndex}}">Resultados Esperados:</label>
            <textarea id="tcExpectedResults-{{data.id}}-{{tcIndex}}" class="form-control" [(ngModel)]="tc.expectedResults" rows="3"></textarea>
        </div>
        </div>

        <div class="form-actions editor-form-actions" *ngIf="data">
          <button type="button" (click)="confirmAndEmitHUData()" class="button-primary">Confirmar y Añadir al Plan</button>
        </div>
    </div>

    <div *ngIf="data && errorScenarios && !(data.detailedTestCases && data.detailedTestCases.length > 0 && data.detailedTestCases[0].title !== 'Información Insuficiente' && data.detailedTestCases[0].title !== 'Imágenes no interpretables o técnica no aplicable' && !data.detailedTestCases[0].title?.startsWith('Error'))" class="error-message generated-data-error" role="alert">
        <p>Error al generar casos de prueba: {{ errorScenarios }}</p>
        <p *ngIf="data.detailedTestCases && data.detailedTestCases.length > 0 && 
                data.detailedTestCases[0] && 
                (!data.detailedTestCases[0].steps || data.detailedTestCases[0].steps.length === 0) &&
                typeof data.detailedTestCases[0].preconditions === 'string' && 
                data.detailedTestCases[0].preconditions.toLowerCase().includes('api')">
            Detalle del error (si aplica): {{ data.detailedTestCases[0].preconditions }}
        </p>
        <button type="button" (click)="resetCurrentInputs()" class="button-secondary" style="margin-top:10px;">Volver a Intentar</button>
    </div>
  </div>

</div>