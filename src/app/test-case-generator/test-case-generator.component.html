<!-- src/app/test-case-generator/test-case-generator.component.html -->
<div class="form-section" aria-labelledby="test-case-form-section-title">
  <div class="form-header-actions">
    <h2 id="test-case-form-section-title">
      <span *ngIf="componentState === 'initialForm'">Datos de Entrada para: </span>
      <span *ngIf="componentState === 'previewingGenerated'">Previsualización de Casos para: </span>
      <span *ngIf="componentState === 'editingForRefinement'">Editando/Refinando Casos para: </span>
      <span *ngIf="componentState === 'submitting'">Enviando: </span>
      <span *ngIf="currentGenerationMode === 'text'">HU por Descripción</span>
      <span *ngIf="currentGenerationMode === 'image'">Casos por Imágenes</span>
      <span *ngIf="componentState !== 'initialForm' && generatedHUData"> ({{ generatedHUData.title }})</span>
    </h2>
    <button type="button" (click)="handleCancelGeneration()" class="button-secondary button-small" [disabled]="componentState === 'submitting'">
      {{ componentState === 'initialForm' ? 'Cancelar y Cambiar Método' : 'Cancelar Generación Actual' }}
    </button>
  </div>

  <!-- FORMULARIO INICIAL -->
  <form (ngSubmit)="generateInitialHuAndCases()" #huForm="ngForm" *ngIf="componentState === 'initialForm'">
    <div class="form-grid">
      <!-- Campos para modo 'text' -->
      <ng-container *ngIf="currentGenerationMode === 'text'">
        <div class="form-group">
          <label for="tcCurrentHuIdText">ID de la HU:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuIdText" type="text" name="currentHuId" [(ngModel)]="currentHuId" required placeholder="Ej: HU_1234" class="form-control">
          <div *ngIf="huForm.controls['currentHuId']?.invalid && (huForm.controls['currentHuId']?.dirty || huForm.controls['currentHuId']?.touched || huForm.submitted)" class="validation-error" role="alert">
            ID de la HU es requerido.
          </div>
        </div>
        <div class="form-group">
          <label for="tcCurrentHuTitleText">Título de la HU:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuTitleText" type="text" name="currentHuTitle" [(ngModel)]="currentHuTitle" required placeholder="Ej: Como usuario, quiero..." class="form-control">
          <div *ngIf="huForm.controls['currentHuTitle']?.invalid && (huForm.controls['currentHuTitle']?.dirty || huForm.controls['currentHuTitle']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Título de la HU es requerido.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcCurrentDescription">Descripción de la HU:<span class="required-indicator">*</span></label>
          <textarea id="tcCurrentDescription" name="currentDescription" [(ngModel)]="currentDescription" rows="4" required placeholder="Ej: La HU describe la funcionalidad..." class="form-control"></textarea>
          <div *ngIf="huForm.controls['currentDescription']?.invalid && (huForm.controls['currentDescription']?.dirty || huForm.controls['currentDescription']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Descripción de la HU es requerida.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcCurrentAcceptanceCriteria">Criterios de Aceptación:<span class="required-indicator">*</span></label>
          <textarea id="tcCurrentAcceptanceCriteria" name="currentAcceptanceCriteria" [(ngModel)]="currentAcceptanceCriteria" rows="6" required placeholder="Ej: - Dado que..." class="form-control"></textarea>
          <div *ngIf="huForm.controls['currentAcceptanceCriteria']?.invalid && (huForm.controls['currentAcceptanceCriteria']?.dirty || huForm.controls['currentAcceptanceCriteria']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Criterios de Aceptación son requeridos.
          </div>
        </div>
      </ng-container>

      <!-- Campos para modo 'image' -->
      <ng-container *ngIf="currentGenerationMode === 'image'">
        <div class="form-group">
          <label for="tcCurrentHuIdImage">ID (Generado desde Título):</label>
          <input id="tcCurrentHuIdImage" type="text" name="currentHuIdGenerated" [value]="generateIdFromTitle(currentHuTitle, currentGenerationMode)" readonly placeholder="Se genera desde el título" class="form-control">
        </div>
        <div class="form-group">
          <label for="tcCurrentHuTitleImage">Título del Conjunto de Imágenes:<span class="required-indicator">*</span></label>
          <input id="tcCurrentHuTitleImage" type="text" name="currentHuTitle" [(ngModel)]="currentHuTitle" required placeholder="Título descriptivo del set de imágenes" class="form-control">
          <div *ngIf="huForm.controls['currentHuTitle']?.invalid && (huForm.controls['currentHuTitle']?.dirty || huForm.controls['currentHuTitle']?.touched || huForm.submitted)" class="validation-error" role="alert">
            Título es requerido.
          </div>
        </div>
        <div class="form-group full-width">
          <label for="tcImageFiles">Cargar Imágenes (JPG, PNG - Máx. 4MB c/u, Máx. 5):<span class="required-indicator">*</span></label>
          <input type="file" id="tcImageFiles" name="imageFiles" (change)="onFileSelected($event)" accept="image/jpeg, image/png"
                 multiple #imageFilesInput>
          <div *ngIf="imageUploadError" class="validation-error" role="alert">{{ imageUploadError }}</div>
          <div *ngIf="huForm.submitted && draggableImages.length === 0 && currentGenerationMode === 'image'" class="validation-error" role="alert">
            Debes seleccionar al menos una imagen.
          </div>

          <div *ngIf="draggableImages.length > 0" class="image-preview-container multiple-previews"
               (dragover)="onImageDragOver($event)" (dragleave)="onImageDragLeave($event)">
            <p>Previsualización ({{ draggableImages.length }}). Arrastra para reordenar:</p>
            <div *ngFor="let imgItem of draggableImages; let i = index"
                 class="image-preview-item" [class.drag-over-element]="dragOverImageId === imgItem.id"
                 draggable="true" (dragstart)="onImageDragStart($event, imgItem)"
                 (drop)="onImageDrop($event, imgItem)" (dragend)="onImageDragEnd($event)"
                 (dragover)="onImageDragOver($event, imgItem)">
              <span class="image-order-badge">{{i + 1}}</span>
              <img [src]="imgItem.preview" [alt]="'Previsualización ' + imgItem.file.name" class="image-preview">
              <span class="image-filename" title="{{ imgItem.file.name }}">{{ imgItem.file.name }}</span>
            </div>
          </div>
        </div>
      </ng-container>

      <div class="form-group">
        <label for="tcCurrentSprint">Sprint:<span class="required-indicator">*</span></label>
        <input id="tcCurrentSprint" type="text" name="currentSprint" [(ngModel)]="currentSprint" required placeholder="Ej: Sprint 1" class="form-control">
        <div *ngIf="huForm.controls['currentSprint']?.invalid && (huForm.controls['currentSprint']?.dirty || huForm.controls['currentSprint']?.touched || huForm.submitted)" class="validation-error" role="alert">
          Sprint es requerido.
        </div>
      </div>

      <div class="form-group">
        <label for="tcCurrentSelectedTechnique">Técnica ISTQB para escenarios (Inicial):<span class="required-indicator">*</span></label>
        <select id="tcCurrentSelectedTechnique" name="currentSelectedTechnique" [(ngModel)]="currentSelectedTechnique" required class="form-control">
          <option value="" disabled>Selecciona una técnica</option>
          <option value="Equivalent Partitioning">Partición Equivalente</option>
          <option value="Boundary Value Analysis">Análisis de Valor Límite</option>
          <option value="Decision Table Testing">Tabla de Decisión</option>
          <option value="State Transition Testing">Pruebas de Transición de Estados</option>
        </select>
        <div *ngIf="huForm.controls['currentSelectedTechnique']?.invalid && (huForm.controls['currentSelectedTechnique']?.dirty || huForm.controls['currentSelectedTechnique']?.touched || huForm.submitted)" class="validation-error" role="alert">
          Debes seleccionar una técnica ISTQB.
        </div>
      </div>
    </div>

    <div class="form-actions main-form-actions">
      <button type="submit" class="button-primary full-width-action" [disabled]="isFormInvalidForGeneration() || loadingScope || loadingScenarios">
        <span *ngIf="loadingScope || loadingScenarios" class="spinner"></span>
        {{ (loadingScope || loadingScenarios) ? 'Generando...' : 'Generar Casos de Prueba' }}
      </button>
    </div>
     <div *ngIf="formError" class="error-message initial-form-error" role="alert">
      <p>{{formError}}</p>
    </div>
  </form>

  <!-- SECCIÓN DE PREVISUALIZACIÓN Y/O EDICIÓN/REFINAMIENTO -->
  <div *ngIf="generatedHUData && (componentState === 'previewingGenerated' || componentState === 'editingForRefinement' || componentState === 'submitting')">
    <div *ngIf="errorScope && generatedHUData.originalInput.generationMode === 'text' || errorScenarios" class="error-message generated-data-error" role="alert">
        <p *ngIf="errorScope && generatedHUData.originalInput.generationMode === 'text'">Error en Alcance: {{ errorScope }}</p>
        <p *ngIf="errorScenarios">Error en Escenarios: {{ errorScenarios }}</p>
    </div>

    <div class="generated-test-cases-editor">
        <h3 *ngIf="generatedHUData.originalInput.generationMode === 'text' && componentState !== 'submitting' && componentState === 'previewingGenerated'">Alcance y Casos de Prueba</h3>
        <h3 *ngIf="generatedHUData.originalInput.generationMode === 'image' && componentState !== 'submitting'">Casos de Prueba</h3>
        <h3 *ngIf="generatedHUData.originalInput.generationMode === 'text' && componentState === 'editingForRefinement'">Casos de Prueba</h3>
        <h3 *ngIf="componentState === 'submitting'">Procesando...</h3>
        
        <div *ngIf="generatedHUData.originalInput.generationMode === 'text' && componentState === 'previewingGenerated'" class="scope-display-section">
          <strong>Alcance Generado:</strong> <span *ngIf="loadingScope" class="spinner-inline"></span>
          <pre [class.loading-text]="loadingScope">{{ loadingScope ? 'Cargando alcance...' : (generatedHUData.generatedScope || 'No se pudo generar el alcance o no aplica.') }}</pre>
        </div>

        <!-- MODO PREVISUALIZACIÓN -->
        <ng-container *ngIf="componentState === 'previewingGenerated'">
            <div *ngIf="!loadingScenarios && generatedHUData.detailedTestCases && generatedHUData.detailedTestCases.length > 0 && !errorScenarios" class="preview-table-container">
                <h4>Casos de Prueba Generados (Previsualización)</h4>
                <table class="detailed-test-cases-table preview-only-table">
                     <thead> <tr> <th>ID Caso</th> <th>Escenario de Prueba (Título)</th> <th>Precondiciones</th> <th>Paso a Paso</th> <th>Resultado Esperado</th> </tr> </thead>
                     <tbody>
                        <tr *ngFor="let tc of generatedHUData.detailedTestCases; let i = index">
                            <td>{{ generatedHUData.id }}_CP{{ i + 1 }}</td>
                            <td>{{ tc.title }}</td>
                            <td><pre class="table-pre">{{ tc.preconditions }}</pre></td>
                            <td>
                                <ul *ngIf="tc.steps && tc.steps.length > 0"><li *ngFor="let step of tc.steps">{{ step.accion }}</li></ul>
                                <span *ngIf="!tc.steps || tc.steps.length === 0">N/A</span>
                            </td>
                            <td><pre class="table-pre">{{ tc.expectedResults }}</pre></td>
                        </tr>
                     </tbody>
                </table>
            </div>
             <div *ngIf="loadingScenarios" class="loading-message-full-editor"><span class="spinner"></span> Cargando Casos...</div>
             <div *ngIf="!loadingScenarios && (!generatedHUData.detailedTestCases || generatedHUData.detailedTestCases.length === 0 || errorScenarios)" class="no-content-message">
                <p>{{ errorScenarios || 'No se generaron casos de prueba o la respuesta fue vacía.'}}</p>
             </div>
        </ng-container>

        <!-- MODO EDICIÓN PARA REFINAMIENTO (NUEVO COMPONENTE) -->
        <ng-container *ngIf="componentState === 'editingForRefinement'">
            <app-test-case-editor
                [testCases]="generatedHUData.detailedTestCases"
                [huId]="generatedHUData.id || 'temp'"
                [isLoading]="loadingScenarios"
                [(refinementTechnique)]="refinementTechnique"
                [(userRefinementContext)]="userRefinementContext"
                [showRefinementControls]="true"
                (refineWithAI)="handleRefineWithAI($event)"
                (testCasesChanged)="handleTestCasesChanged($event)"
                (cancel)="cancelRefinementEditing()">
            </app-test-case-editor>
        </ng-container>

        <!-- Acciones Finales -->
        <div class="form-actions editor-form-actions final-actions-group" *ngIf="componentState !== 'submitting'">
            <button type="button" (click)="exportExecutionMatrixLocal()" class="button-secondary" 
                    [disabled]="loadingScenarios || loadingScope || !generatedHUData.detailedTestCases || generatedHUData.detailedTestCases.length === 0 || generatedHUData.detailedTestCases[0].title.startsWith('Error')">
                Exportar Matriz (.csv)
            </button>
            <button type="button" (click)="startRefinementMode()" class="button-edit" 
                    *ngIf="componentState === 'previewingGenerated'"
                    [disabled]="loadingScenarios || loadingScope || !generatedHUData.detailedTestCases || generatedHUData.detailedTestCases.length === 0 || generatedHUData.detailedTestCases[0].title.startsWith('Error')">
                Refinar con IA / Editar Casos
            </button>
            <button type="button" (click)="confirmAndEmitHUDataToPlan()" class="button-primary" 
                    [disabled]="loadingScenarios || loadingScope">
                Confirmar y Añadir al Plan
            </button>
        </div>
        <div *ngIf="componentState === 'submitting'" class="loading-message-full-editor">
            <span class="spinner"></span> Enviando al plan de pruebas...
        </div>
    </div>
  </div>
</div>